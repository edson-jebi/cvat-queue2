{% extends "base.html" %}
{% block title %}Analytics - {{ task.name if task else 'Task' }} - CVAT Queue{% endblock %}

{% block content %}

<!-- Loading Overlay -->
<div id="loading-overlay" class="apple-loading-overlay hidden">
    <div class="apple-loading-content">
        <div class="apple-spinner"></div>
        <p class="apple-loading-text">Refreshing Data...</p>
        <p class="apple-loading-subtext">Capturing new snapshot with updated label statistics</p>
    </div>
</div>

<div class="mb-10">
    <a href="/task/{{ task_id }}" class="apple-breadcrumb mb-4 inline-flex">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span>Task</span>
    </a>

    <div class="flex justify-between items-start mt-4">
        <div>
            <h1 class="apple-title-2 text-gray-900">
                {% if task %}{{ task.name }}{% else %}Task{% endif %} - Analytics
            </h1>
            <p class="apple-subheadline text-gray-500 mt-2">Task ID: {{ task_id }}</p>
        </div>

        <div class="flex gap-3">
            <button onclick="generateReport()" class="apple-btn apple-btn-success">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export Report
            </button>
            <form method="POST" action="/task/{{ task_id }}/analytics/refresh" onsubmit="showLoadingOverlay()">
                <button type="submit" class="apple-btn apple-btn-primary">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Data
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Timeline Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="apple-stat-card">
        <p class="apple-stat-label">Snapshots</p>
        <p class="apple-stat-value">{{ history|length }}</p>
    </div>

    <div class="apple-stat-card">
        <p class="apple-stat-label">Latest Count</p>
        <p class="apple-stat-value primary">
            {% if history|length > 0 %}
                {{ history[-1].annotation_count }}
            {% else %}
                -
            {% endif %}
        </p>
    </div>

    <div class="apple-stat-card">
        <p class="apple-stat-label">Change Since First</p>
        <p class="apple-stat-value success">
            {% if history|length > 1 %}
                +{{ history[-1].annotation_count - history[0].annotation_count }}
            {% else %}
                -
            {% endif %}
        </p>
    </div>
</div>

<!-- Annotation Timeline Chart -->
<div class="apple-card mb-8">
    <div class="apple-card-header">
        <h2>Annotation Timeline</h2>
    </div>
    <div class="apple-card-body">
        {% if history %}
        <div style="height: 350px;">
            <canvas id="annotationChart"></canvas>
        </div>
        {% else %}
        <div class="apple-empty-state py-16">
            <div class="apple-empty-icon">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <h3 class="apple-empty-heading">No Data Available</h3>
            <p class="apple-empty-text">Click "Refresh Data" to capture the first snapshot.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Annotations by Job Toggle Section -->
<div class="apple-card mb-8">
    <div class="apple-card-header flex justify-between items-center">
        <h2>Annotations by Job</h2>
        <label class="apple-toggle">
            <input type="checkbox" id="jobs-toggle" onchange="toggleJobsData()">
            <span class="apple-toggle-slider"></span>
        </label>
    </div>

    <!-- Loading indicator -->
    <div id="jobs-loading" class="hidden p-12 text-center">
        <div class="apple-spinner mx-auto"></div>
        <p class="mt-4 text-gray-500">Loading job data from CVAT...</p>
    </div>

    <!-- Jobs Stats (dynamic) -->
    <div id="jobs-stats" class="hidden p-6 border-b border-gray-100">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="apple-stat-card">
                <p class="apple-stat-label">Total Jobs</p>
                <p class="apple-stat-value text-2xl" id="stat-total-jobs">-</p>
            </div>
            <div class="apple-stat-card">
                <p class="apple-stat-label">Total Annotations</p>
                <p class="apple-stat-value text-2xl primary" id="stat-total-annotations">-</p>
            </div>
            <div class="apple-stat-card">
                <p class="apple-stat-label">Total Frames</p>
                <p class="apple-stat-value text-2xl" id="stat-total-frames">-</p>
            </div>
            <div class="apple-stat-card">
                <p class="apple-stat-label">Avg Ann/Job</p>
                <p class="apple-stat-value text-2xl purple" id="stat-avg-annotations">-</p>
            </div>
        </div>
    </div>

    <!-- Jobs Table -->
    <div id="jobs-table" class="hidden">
        <table class="apple-table">
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>Assignee</th>
                    <th>Stage</th>
                    <th>State</th>
                    <th>Frames</th>
                    <th class="text-right">Annotations</th>
                    <th class="text-right">Labels</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="jobs-tbody">
                <!-- Jobs will be loaded here dynamically -->
            </tbody>
            <tfoot class="bg-gray-50">
                <tr>
                    <td colspan="5" class="px-6 py-4 text-sm font-medium text-gray-700 text-right">Total:</td>
                    <td class="px-6 py-4 text-sm text-right font-bold text-indigo-600" id="jobs-total-annotations">-</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Labels Statistics Toggle Section -->
<div class="apple-card mb-8">
    <div class="apple-card-header flex justify-between items-center">
        <h2>Labels Statistics</h2>
        <label class="apple-toggle">
            <input type="checkbox" id="labels-toggle" onchange="toggleLabelsData()">
            <span class="apple-toggle-slider"></span>
        </label>
    </div>

    <!-- Loading indicator -->
    <div id="labels-loading" class="hidden p-12 text-center">
        <div class="apple-spinner mx-auto"></div>
        <p class="mt-4 text-gray-500">Loading label statistics...</p>
    </div>

    <!-- Labels Stats (dynamic) -->
    <div id="labels-stats" class="hidden p-6 border-b border-gray-100">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="apple-stat-card">
                <p class="apple-stat-label">Total Labels</p>
                <p class="apple-stat-value text-2xl" id="stat-total-labels">-</p>
            </div>
            <div class="apple-stat-card">
                <p class="apple-stat-label">Total Annotations</p>
                <p class="apple-stat-value text-2xl primary" id="stat-labels-annotations">-</p>
            </div>
            <div class="apple-stat-card">
                <p class="apple-stat-label">Snapshots</p>
                <p class="apple-stat-value text-2xl" id="stat-labels-snapshots">-</p>
            </div>
            <div class="apple-stat-card">
                <p class="apple-stat-label">Avg Ann/Label</p>
                <p class="apple-stat-value text-2xl purple" id="stat-avg-label-annotations">-</p>
            </div>
        </div>
    </div>

    <!-- Labels Charts -->
    <div id="labels-charts" class="hidden p-6 space-y-6">
        <!-- Chart Type Buttons -->
        <div class="flex gap-2 justify-center">
            <button onclick="showLabelChart('bar')" id="chart-btn-bar" class="apple-btn apple-btn-primary apple-btn-sm">
                Bar Chart
            </button>
            <button onclick="showLabelChart('pie')" id="chart-btn-pie" class="apple-btn apple-btn-secondary apple-btn-sm">
                Pie Chart
            </button>
            <button onclick="showLabelChart('timeline')" id="chart-btn-timeline" class="apple-btn apple-btn-secondary apple-btn-sm">
                Timeline
            </button>
        </div>

        <!-- Chart Container -->
        <div id="labels-chart-container" class="bg-gray-50 rounded-xl p-4" style="min-height: 400px;"></div>

        <!-- Labels Table -->
        <div id="labels-table-container">
            <h3 class="apple-headline text-gray-900 mb-4">Label Details</h3>
            <div class="apple-card">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>Label Name</th>
                            <th class="text-right">Count</th>
                            <th class="text-right">Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="labels-tbody">
                        <!-- Labels will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Note about asterisk -->
        <div id="unmapped-note" class="hidden apple-alert apple-alert-info">
            <div class="apple-alert-icon">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="apple-alert-content">
                <p><strong>Note:</strong> Labels marked with (*) have unmapped or invalid label IDs. This may indicate deleted labels or data synchronization issues.</p>
            </div>
        </div>
    </div>
</div>

<!-- Job Labels Modal -->
<div id="job-labels-modal" class="apple-modal-overlay hidden">
    <div class="apple-modal apple-modal-lg">
        <div class="apple-modal-header">
            <h2>Job <span id="modal-job-id"></span> - Label Statistics</h2>
            <button onclick="closeJobLabelsModal()" class="apple-modal-close">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="apple-modal-body">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="apple-stat-card">
                    <p class="apple-stat-label">Unique Labels</p>
                    <p class="apple-stat-value text-2xl" id="modal-total-labels">-</p>
                </div>
                <div class="apple-stat-card">
                    <p class="apple-stat-label">Total Annotations</p>
                    <p class="apple-stat-value text-2xl primary" id="modal-total-annotations">-</p>
                </div>
            </div>

            <!-- Chart -->
            <div id="modal-chart-container" class="mb-6 bg-gray-50 rounded-xl p-4" style="min-height: 300px;"></div>

            <!-- Table -->
            <h3 class="apple-headline text-gray-900 mb-4">Label Details</h3>
            <div class="apple-card">
                <table class="apple-table">
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th class="text-right">Count</th>
                            <th class="text-right">Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="modal-labels-tbody">
                        <!-- Labels will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Unmapped note -->
            <div id="modal-unmapped-note" class="hidden mt-4 apple-alert apple-alert-info">
                <div class="apple-alert-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="apple-alert-content">
                    <p><strong>Note:</strong> Labels marked with (*) have unmapped or invalid label IDs.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Collapsible Snapshot History -->
{% if history %}
<div class="apple-card mb-8">
    <div class="apple-card-header flex justify-between items-center cursor-pointer" onclick="toggleHistoryTable()">
        <h2>Snapshot History</h2>
        <span id="history-toggle-icon" class="text-gray-400 transform transition-transform duration-200">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </span>
    </div>

    <div id="history-table" class="hidden">
        <table class="apple-table">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Annotation Count</th>
                    <th>Change</th>
                </tr>
            </thead>
            <tbody>
                {% for snapshot in history %}
                <tr>
                    <td class="text-gray-600">
                        {{ snapshot.snapshot_time.strftime('%Y-%m-%d %H:%M:%S') }}
                    </td>
                    <td class="font-medium">
                        {{ snapshot.annotation_count }}
                    </td>
                    <td>
                        {% if loop.index0 > 0 %}
                            {% set change = snapshot.annotation_count - history[loop.index0 - 1].annotation_count %}
                            {% if change > 0 %}
                                <span class="text-green-600 font-medium">+{{ change }}</span>
                            {% elif change < 0 %}
                                <span class="text-red-600 font-medium">{{ change }}</span>
                            {% else %}
                                <span class="text-gray-400">0</span>
                            {% endif %}
                        {% else %}
                            <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Report Modal -->
<div id="report-modal" class="apple-modal-overlay hidden">
    <div class="apple-modal apple-modal-xl">
        <div class="apple-modal-header">
            <h2>Analytics Report</h2>
            <div class="flex gap-2">
                <button onclick="exportCSV()" class="apple-btn apple-btn-success apple-btn-sm">
                    Export CSV
                </button>
                <button onclick="printReport()" class="apple-btn apple-btn-primary apple-btn-sm">
                    Print
                </button>
                <button onclick="closeReportModal()" class="apple-modal-close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="report-content" class="apple-modal-body">
            <!-- Report content will be generated here -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    // Store loaded data
    let loadedJobsData = null;
    let loadedLabelsData = null;
    let loadedLabelsHistory = null;
    let loadedRejectionsData = null;
    let currentLabelChartType = 'bar';

    // Show loading overlay
    function showLoadingOverlay() {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // Hide loading overlay
    function hideLoadingOverlay() {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Toggle history table
    function toggleHistoryTable() {
        const table = document.getElementById('history-table');
        const icon = document.getElementById('history-toggle-icon');
        table.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }

    // Toggle jobs data with fetch
    async function toggleJobsData() {
        const toggle = document.getElementById('jobs-toggle');
        const loading = document.getElementById('jobs-loading');
        const stats = document.getElementById('jobs-stats');
        const table = document.getElementById('jobs-table');

        if (toggle.checked) {
            // If data not loaded, fetch it
            if (!loadedJobsData) {
                loading.classList.remove('hidden');
                stats.classList.add('hidden');
                table.classList.add('hidden');

                try {
                    const response = await fetch('/task/{{ task_id }}/analytics/jobs', {
                        headers: { 'X-Requested-With': 'fetch' }
                    });

                    if (!response.ok) throw new Error('Failed to load jobs data');

                    loadedJobsData = await response.json();
                    renderJobsData(loadedJobsData);
                } catch (error) {
                    console.error('Error loading jobs:', error);
                    loading.innerHTML = '<p class="text-red-500">Failed to load job data. Please try again.</p>';
                    return;
                }
            }

            loading.classList.add('hidden');
            stats.classList.remove('hidden');
            table.classList.remove('hidden');
        } else {
            stats.classList.add('hidden');
            table.classList.add('hidden');
        }
    }

    // Render jobs data
    function renderJobsData(data) {
        // Update stats
        document.getElementById('stat-total-jobs').textContent = data.total_jobs;
        document.getElementById('stat-total-annotations').textContent = data.total_annotations;
        document.getElementById('stat-total-frames').textContent = data.total_frames;
        document.getElementById('stat-avg-annotations').textContent =
            data.total_jobs > 0 ? (data.total_annotations / data.total_jobs).toFixed(1) : '0';

        // Build table rows
        const tbody = document.getElementById('jobs-tbody');
        tbody.innerHTML = data.jobs.map(job => `
            <tr>
                <td class="font-mono font-medium">${job.id}</td>
                <td class="text-gray-500">${job.assignee}</td>
                <td>
                    <span class="apple-badge apple-stage-${job.stage}">
                        ${job.stage}
                    </span>
                </td>
                <td>
                    <span class="apple-badge apple-state-${job.state.replace(' ', '_')}">
                        ${job.state}
                    </span>
                </td>
                <td class="text-gray-500">${job.frame_count}</td>
                <td class="text-right font-semibold text-indigo-600">${job.annotation_count}</td>
                <td class="text-right font-semibold text-purple-600">${job.label_count}</td>
                <td class="text-center">
                    <button onclick="showJobLabels(${job.id})"
                            class="apple-btn apple-btn-primary apple-btn-sm">
                        View Labels
                    </button>
                </td>
            </tr>
        `).join('');

        document.getElementById('jobs-total-annotations').textContent = data.total_annotations;
    }

    // Toggle labels data with fetch
    async function toggleLabelsData() {
        const toggle = document.getElementById('labels-toggle');
        const loading = document.getElementById('labels-loading');
        const stats = document.getElementById('labels-stats');
        const charts = document.getElementById('labels-charts');

        if (toggle.checked) {
            if (!loadedLabelsHistory) {
                loading.classList.remove('hidden');
                stats.classList.add('hidden');
                charts.classList.add('hidden');

                try {
                    const response = await fetch('/task/{{ task_id }}/analytics/labels/history', {
                        headers: { 'X-Requested-With': 'fetch' }
                    });

                    if (!response.ok) throw new Error('Failed to load labels data');

                    loadedLabelsHistory = await response.json();

                    if (!loadedLabelsHistory.has_data) {
                        loading.innerHTML = `<p class="text-yellow-600">${loadedLabelsHistory.message}</p>`;
                        return;
                    }

                    renderLabelsDataWithHistory(loadedLabelsHistory);
                } catch (error) {
                    console.error('Error loading labels:', error);
                    loading.innerHTML = '<p class="text-red-500">Failed to load label statistics. Please try again.</p>';
                    return;
                }
            }

            loading.classList.add('hidden');
            stats.classList.remove('hidden');
            charts.classList.remove('hidden');
        } else {
            stats.classList.add('hidden');
            charts.classList.add('hidden');
        }
    }

    // Render labels data with history
    function renderLabelsDataWithHistory(data) {
        // Update stats
        document.getElementById('stat-total-labels').textContent = data.total_labels;
        document.getElementById('stat-labels-annotations').textContent = data.total_annotations;
        document.getElementById('stat-labels-snapshots').textContent = data.snapshots_count;
        document.getElementById('stat-avg-label-annotations').textContent =
            data.total_labels > 0 ? (data.total_annotations / data.total_labels).toFixed(1) : '0';

        // Build labels table
        const tbody = document.getElementById('labels-tbody');
        let hasUnmapped = false;
        tbody.innerHTML = data.current_labels.map(label => {
            const percentage = data.total_annotations > 0 ? ((label.count / data.total_annotations) * 100).toFixed(1) : '0';
            const isUnmapped = label.name.includes('(*)');
            if (isUnmapped) hasUnmapped = true;
            const rowClass = isUnmapped ? 'bg-yellow-50' : '';
            return `
                <tr class="${rowClass}">
                    <td>${label.name}</td>
                    <td class="text-right font-semibold text-indigo-600">${label.count}</td>
                    <td class="text-right text-gray-500">${percentage}%</td>
                </tr>
            `;
        }).join('');

        // Show/hide unmapped note
        document.getElementById('unmapped-note').classList.toggle('hidden', !hasUnmapped);

        // Show default chart
        showLabelChart('bar');
    }

    // Show label chart by type
    function showLabelChart(type) {
        currentLabelChartType = type;

        // Update button styles
        ['bar', 'pie', 'timeline'].forEach(t => {
            const btn = document.getElementById(`chart-btn-${t}`);
            if (t === type) {
                btn.className = 'apple-btn apple-btn-primary apple-btn-sm';
            } else {
                btn.className = 'apple-btn apple-btn-secondary apple-btn-sm';
            }
        });

        const container = document.getElementById('labels-chart-container');

        if (type === 'bar') {
            renderBarChart(container, loadedLabelsHistory.current_labels);
        } else if (type === 'pie') {
            renderPieChart(container, loadedLabelsHistory.current_labels);
        } else if (type === 'timeline') {
            renderTimelineChart(container, loadedLabelsHistory);
        }
    }

    // Render bar chart with Plotly
    function renderBarChart(container, labels) {
        const trace = {
            x: labels.map(l => l.name),
            y: labels.map(l => l.count),
            type: 'bar',
            marker: {
                color: labels.map(l => l.name.includes('(*)') ? '#fbbf24' : '#007AFF')
            }
        };

        const layout = {
            title: 'Label Distribution',
            xaxis: { title: 'Label', tickangle: -45 },
            yaxis: { title: 'Count' },
            margin: { b: 150 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
        };

        Plotly.newPlot(container, [trace], layout, { responsive: true });
    }

    // Render pie chart with Plotly
    function renderPieChart(container, labels) {
        const trace = {
            labels: labels.map(l => l.name),
            values: labels.map(l => l.count),
            type: 'pie',
            marker: {
                colors: labels.map((l, i) => l.name.includes('(*)') ? '#fbbf24' : `hsl(${(i * 360 / labels.length)}, 70%, 60%)`)
            }
        };

        const layout = {
            title: 'Label Distribution (Percentage)',
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
        };

        Plotly.newPlot(container, [trace], layout, { responsive: true });
    }

    // Render timeline chart with Plotly
    function renderTimelineChart(container, data) {
        const traces = [];
        const labelNames = Object.keys(data.timeline_data);

        labelNames.forEach((label, i) => {
            traces.push({
                x: data.timestamps,
                y: data.timeline_data[label],
                name: label,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: label.includes('(*)') ? '#fbbf24' : `hsl(${(i * 360 / labelNames.length)}, 70%, 50%)` }
            });
        });

        const layout = {
            title: 'Label Trends Over Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Count' },
            legend: { orientation: 'h', y: -0.2 },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
        };

        Plotly.newPlot(container, traces, layout, { responsive: true });
    }

    // Show job labels modal
    async function showJobLabels(jobId) {
        const modal = document.getElementById('job-labels-modal');
        const tbody = document.getElementById('modal-labels-tbody');
        const chartContainer = document.getElementById('modal-chart-container');

        document.getElementById('modal-job-id').textContent = jobId;
        document.getElementById('modal-total-labels').textContent = '-';
        document.getElementById('modal-total-annotations').textContent = '-';
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8">Loading...</td></tr>';
        chartContainer.innerHTML = '<div class="flex justify-center items-center h-64"><div class="apple-spinner"></div></div>';

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        try {
            const response = await fetch(`/job/${jobId}/analytics/labels`, {
                headers: { 'X-Requested-With': 'fetch' }
            });

            if (!response.ok) throw new Error('Failed to load job label statistics');

            const data = await response.json();

            document.getElementById('modal-total-labels').textContent = data.total_labels;
            document.getElementById('modal-total-annotations').textContent = data.total_annotations;

            // Render table
            let hasUnmapped = false;
            tbody.innerHTML = data.labels.map(label => {
                const percentage = data.total_annotations > 0 ? ((label.count / data.total_annotations) * 100).toFixed(1) : '0';
                const isUnmapped = label.name.includes('(*)');
                if (isUnmapped) hasUnmapped = true;
                const rowClass = isUnmapped ? 'bg-yellow-50' : '';
                return `
                    <tr class="${rowClass}">
                        <td>${label.name}</td>
                        <td class="text-right font-semibold text-indigo-600">${label.count}</td>
                        <td class="text-right text-gray-500">${percentage}%</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('modal-unmapped-note').classList.toggle('hidden', !hasUnmapped);

            // Render chart
            const trace = {
                x: data.labels.map(l => l.name),
                y: data.labels.map(l => l.count),
                type: 'bar',
                marker: {
                    color: data.labels.map(l => l.name.includes('(*)') ? '#fbbf24' : '#007AFF')
                }
            };

            const layout = {
                title: `Job ${jobId} - Label Distribution`,
                xaxis: { title: 'Label', tickangle: -45 },
                yaxis: { title: 'Count' },
                margin: { b: 120 },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };

            Plotly.newPlot(chartContainer, [trace], layout, { responsive: true });

        } catch (error) {
            console.error('Error loading job labels:', error);
            tbody.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-red-500">Failed to load: ${error.message}</td></tr>`;
            chartContainer.innerHTML = '<p class="text-center text-red-500">Failed to load chart</p>';
        }
    }

    // Close job labels modal
    function closeJobLabelsModal() {
        const modal = document.getElementById('job-labels-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Report data (timeline only by default)
    const reportData = {
        taskName: '{{ task.name if task else "Task " ~ task_id }}',
        taskId: {{ task_id }},
        generatedAt: new Date().toISOString(),
        timeline: [
            {% for snapshot in history %}
            {
                time: '{{ snapshot.snapshot_time.strftime("%Y-%m-%d %H:%M:%S") }}',
                count: {{ snapshot.annotation_count }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };

    async function generateReport() {
        const modal = document.getElementById('report-modal');
        const content = document.getElementById('report-content');

        // Show loading state
        content.innerHTML = '<div class="flex justify-center items-center p-12"><div class="apple-spinner"></div><p class="ml-4 text-gray-500">Loading report data...</p></div>';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Fetch rejection data if not already loaded
        if (!loadedRejectionsData) {
            try {
                const response = await fetch('/task/{{ task_id }}/analytics/rejections', {
                    headers: { 'X-Requested-With': 'fetch' }
                });
                if (response.ok) {
                    loadedRejectionsData = await response.json();
                }
            } catch (error) {
                console.error('Error loading rejections:', error);
                loadedRejectionsData = { total_rejections: 0, by_assignee: [] };
            }
        }

        // Build rejection lookup map by assignee
        const rejectionsByAssignee = {};
        if (loadedRejectionsData && loadedRejectionsData.by_assignee) {
            loadedRejectionsData.by_assignee.forEach(r => {
                rejectionsByAssignee[r.assignee] = r;
            });
        }

        let html = `
            <div class="print-content">
                <div class="text-center mb-8">
                    <h1 class="apple-title-2 text-gray-900">${reportData.taskName}</h1>
                    <p class="apple-subheadline text-gray-500 mt-2">Task ID: ${reportData.taskId} | Generated: ${new Date().toLocaleString()}</p>
                </div>
        `;

        // Add jobs data if loaded
        if (loadedJobsData) {
            const jobsByAssignee = {};
            loadedJobsData.jobs.forEach(job => {
                const assignee = job.assignee || 'Unassigned';
                if (!jobsByAssignee[assignee]) {
                    jobsByAssignee[assignee] = { jobs: 0, annotations: 0, frames: 0 };
                }
                jobsByAssignee[assignee].jobs++;
                jobsByAssignee[assignee].annotations += job.annotation_count;
                jobsByAssignee[assignee].frames += job.frame_count;
            });

            const jobsByStage = {};
            loadedJobsData.jobs.forEach(job => {
                if (!jobsByStage[job.stage]) {
                    jobsByStage[job.stage] = { count: 0, annotations: 0 };
                }
                jobsByStage[job.stage].count++;
                jobsByStage[job.stage].annotations += job.annotation_count;
            });

            const totalRejections = loadedRejectionsData ? loadedRejectionsData.total_rejections : 0;

            html += `
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <div class="apple-stat-card text-center">
                        <p class="apple-stat-value text-2xl">${loadedJobsData.total_jobs}</p>
                        <p class="apple-stat-label">Total Jobs</p>
                    </div>
                    <div class="apple-stat-card text-center">
                        <p class="apple-stat-value text-2xl primary">${loadedJobsData.total_annotations}</p>
                        <p class="apple-stat-label">Total Annotations</p>
                    </div>
                    <div class="apple-stat-card text-center">
                        <p class="apple-stat-value text-2xl">${loadedJobsData.total_frames}</p>
                        <p class="apple-stat-label">Total Frames</p>
                    </div>
                    <div class="apple-stat-card text-center">
                        <p class="apple-stat-value text-2xl purple">${loadedJobsData.total_jobs > 0 ? (loadedJobsData.total_annotations / loadedJobsData.total_jobs).toFixed(1) : 0}</p>
                        <p class="apple-stat-label">Avg Ann/Job</p>
                    </div>
                    <div class="apple-stat-card text-center">
                        <p class="apple-stat-value text-2xl ${totalRejections > 0 ? 'text-red-600' : ''}">${totalRejections}</p>
                        <p class="apple-stat-label">Total Rejections</p>
                    </div>
                </div>

                <h3 class="apple-headline text-gray-900 mb-4">Performance by Labeler</h3>
                <div class="apple-card mb-6">
                    <table class="apple-table">
                        <thead>
                            <tr>
                                <th>Labeler</th>
                                <th class="text-right">Jobs</th>
                                <th class="text-right">Frames</th>
                                <th class="text-right">Annotations</th>
                                <th class="text-right">Avg/Job</th>
                                <th class="text-right">Rejections</th>
                                <th class="text-right">Rejection Rate</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(jobsByAssignee).forEach(([assignee, data]) => {
                const avg = data.jobs > 0 ? (data.annotations / data.jobs).toFixed(1) : 0;
                const rejectionData = rejectionsByAssignee[assignee] || { total_rejections: 0, unique_jobs_rejected: 0 };
                const rejectionRate = data.jobs > 0 ? ((rejectionData.unique_jobs_rejected / data.jobs) * 100).toFixed(1) : 0;
                const rejectionClass = rejectionData.total_rejections > 0 ? 'text-red-600 font-semibold' : 'text-gray-400';
                const rateClass = parseFloat(rejectionRate) > 20 ? 'text-red-600 font-semibold' : (parseFloat(rejectionRate) > 10 ? 'text-yellow-600' : 'text-green-600');
                html += `
                    <tr>
                        <td>${assignee}</td>
                        <td class="text-right">${data.jobs}</td>
                        <td class="text-right">${data.frames}</td>
                        <td class="text-right font-semibold">${data.annotations}</td>
                        <td class="text-right">${avg}</td>
                        <td class="text-right ${rejectionClass}">${rejectionData.total_rejections}</td>
                        <td class="text-right ${rateClass}">${rejectionRate}%</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <h3 class="apple-headline text-gray-900 mb-4">Jobs by Stage</h3>
                <div class="apple-card mb-6">
                    <table class="apple-table">
                        <thead>
                            <tr>
                                <th>Stage</th>
                                <th class="text-right">Jobs</th>
                                <th class="text-right">Annotations</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.entries(jobsByStage).forEach(([stage, data]) => {
                html += `
                    <tr>
                        <td class="capitalize">${stage}</td>
                        <td class="text-right">${data.count}</td>
                        <td class="text-right font-semibold">${data.annotations}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <h3 class="apple-headline text-gray-900 mb-4">All Jobs Detail</h3>
                <div class="apple-card mb-6">
                    <table class="apple-table text-sm">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Assignee</th>
                                <th>Stage</th>
                                <th>State</th>
                                <th class="text-right">Frames</th>
                                <th class="text-right">Annotations</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            loadedJobsData.jobs.forEach(job => {
                html += `
                    <tr>
                        <td class="font-mono">${job.id}</td>
                        <td>${job.assignee}</td>
                        <td class="capitalize">${job.stage}</td>
                        <td class="capitalize">${job.state}</td>
                        <td class="text-right">${job.frame_count}</td>
                        <td class="text-right font-semibold">${job.annotation_count}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            html += `
                <div class="apple-alert apple-alert-info mb-6">
                    <div class="apple-alert-icon">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="apple-alert-content">
                        <p><strong>Note:</strong> Job data is not loaded. Enable "Annotations by Job" toggle to include job details in the report.</p>
                    </div>
                </div>
            `;
        }

        // Timeline history
        if (reportData.timeline.length > 0) {
            html += `
                <h3 class="apple-headline text-gray-900 mb-4">Timeline History</h3>
                <div class="apple-card">
                    <table class="apple-table text-sm">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th class="text-right">Annotations</th>
                                <th class="text-right">Change</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            reportData.timeline.forEach((snapshot, index) => {
                const change = index > 0 ? snapshot.count - reportData.timeline[index - 1].count : 0;
                const changeClass = change > 0 ? 'text-green-600' : (change < 0 ? 'text-red-600' : 'text-gray-400');
                const changeStr = index > 0 ? (change > 0 ? `+${change}` : change) : '-';
                html += `
                    <tr>
                        <td>${snapshot.time}</td>
                        <td class="text-right font-semibold">${snapshot.count}</td>
                        <td class="text-right ${changeClass}">${changeStr}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
        }

        html += '</div>';

        content.innerHTML = html;
        // Modal already shown at start with loading state
    }

    function closeReportModal() {
        document.getElementById('report-modal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    function exportCSV() {
        let csv = '';

        if (loadedJobsData) {
            csv = 'Job ID,Assignee,Stage,State,Frames,Annotations\n';
            loadedJobsData.jobs.forEach(job => {
                csv += `${job.id},"${job.assignee}",${job.stage},${job.state},${job.frame_count},${job.annotation_count}\n`;
            });
            csv += '\n';

            // Add labeler summary with rejections
            csv += 'Labeler Performance Summary\n';
            csv += 'Labeler,Jobs,Frames,Annotations,Avg/Job,Rejections,Rejection Rate\n';

            const jobsByAssignee = {};
            loadedJobsData.jobs.forEach(job => {
                const assignee = job.assignee || 'Unassigned';
                if (!jobsByAssignee[assignee]) {
                    jobsByAssignee[assignee] = { jobs: 0, annotations: 0, frames: 0 };
                }
                jobsByAssignee[assignee].jobs++;
                jobsByAssignee[assignee].annotations += job.annotation_count;
                jobsByAssignee[assignee].frames += job.frame_count;
            });

            const rejectionsByAssignee = {};
            if (loadedRejectionsData && loadedRejectionsData.by_assignee) {
                loadedRejectionsData.by_assignee.forEach(r => {
                    rejectionsByAssignee[r.assignee] = r;
                });
            }

            Object.entries(jobsByAssignee).forEach(([assignee, data]) => {
                const avg = data.jobs > 0 ? (data.annotations / data.jobs).toFixed(1) : 0;
                const rejectionData = rejectionsByAssignee[assignee] || { total_rejections: 0, unique_jobs_rejected: 0 };
                const rejectionRate = data.jobs > 0 ? ((rejectionData.unique_jobs_rejected / data.jobs) * 100).toFixed(1) : 0;
                csv += `"${assignee}",${data.jobs},${data.frames},${data.annotations},${avg},${rejectionData.total_rejections},${rejectionRate}%\n`;
            });
            csv += '\n';
        }

        // Add rejections summary if available
        if (loadedRejectionsData && loadedRejectionsData.total_rejections > 0) {
            csv += 'Rejection Summary\n';
            csv += 'Labeler,Total Rejections,Unique Jobs Rejected\n';
            loadedRejectionsData.by_assignee.forEach(r => {
                csv += `"${r.assignee}",${r.total_rejections},${r.unique_jobs_rejected}\n`;
            });
            csv += '\n';
        }

        csv += 'Timeline History\nDate & Time,Annotation Count,Change\n';
        reportData.timeline.forEach((snapshot, index) => {
            const change = index > 0 ? snapshot.count - reportData.timeline[index - 1].count : 0;
            csv += `"${snapshot.time}",${snapshot.count},${change}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analytics_task_${reportData.taskId}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function printReport() {
        const content = document.getElementById('report-content').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Analytics Report - ${reportData.taskName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link rel="stylesheet" href="/static/css/apple-design.css">
                <style>
                    @media print {
                        body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                    }
                </style>
            </head>
            <body class="p-8">
                ${content}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.onload = () => {
            printWindow.print();
        };
    }

    // Close modals on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeJobLabelsModal();
            closeReportModal();
        }
    });

    // Close modals on overlay click
    document.querySelectorAll('.apple-modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
        });
    });

    // Chart with data labels - increased height
    {% if history %}
    const ctx = document.getElementById('annotationChart').getContext('2d');

    Chart.register(ChartDataLabels);

    const data = {
        labels: [
            {% for snapshot in history %}
                '{{ snapshot.snapshot_time.strftime("%m/%d %H:%M") }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Annotation Count',
            data: [
                {% for snapshot in history %}
                    {{ snapshot.annotation_count }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#007AFF',
            backgroundColor: 'rgba(0, 122, 255, 0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 6,
            pointHoverRadius: 10,
            pointBackgroundColor: '#007AFF',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }]
    };

    const config = {
        type: 'line',
        data: data,
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 30,
                    right: 20,
                    bottom: 10,
                    left: 10
                }
            },
            plugins: {
                legend: {
                    display: false,
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            label += context.parsed.y;
                            if (context.dataIndex > 0) {
                                const change = context.parsed.y - data.datasets[0].data[context.dataIndex - 1];
                                label += ` (${change >= 0 ? '+' : ''}${change})`;
                            }
                            return label;
                        }
                    }
                },
                datalabels: {
                    align: 'top',
                    anchor: 'end',
                    offset: 8,
                    color: '#007AFF',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grace: '15%',
                    ticks: {
                        precision: 0
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    };

    new Chart(ctx, config);
    {% endif %}
</script>

<style>
    @media print {
        .print-content { page-break-inside: avoid; }
    }
</style>
{% endblock %}
