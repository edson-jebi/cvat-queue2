{% extends "base.html" %}
{% block title %}Validation Queue - CVAT Queue{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">{% if user.is_admin %}Validation Queue{% else %}My Assigned Jobs{% endif %}</h1>
        <p class="text-gray-500">{% if user.is_admin %}Jobs waiting for review, grouped by task{% else %}Jobs assigned to you for review{% endif %}</p>
    </div>
    {% if user.is_admin %}
    <a href="/admin/queue" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm">
        Bulk Assign
    </a>
    {% endif %}
</div>

{% if jobs_by_task %}
    {% for task_name, task_jobs in jobs_by_task.items() %}
    <div class="bg-white rounded-lg shadow mb-6">
        <!-- Task Header -->
        <div class="px-4 py-3 bg-gray-50 border-b rounded-t-lg flex justify-between items-center">
            <div>
                <h2 class="font-semibold text-gray-800">{{ task_name }}</h2>
                <span class="text-sm text-gray-500">{{ task_jobs | length }} job(s) pending</span>
            </div>
            {% if user.is_admin %}
            <form method="POST" action="/queue/assign-task" class="flex items-center gap-2">
                <input type="hidden" name="task_name" value="{{ task_name }}">
                <select name="reviewer_id" required class="text-sm px-2 py-1 border rounded focus:ring-1 focus:ring-indigo-500">
                    <option value="">Assign all to...</option>
                    {% for u in all_users %}
                    <option value="{{ u.id }}">{{ u.username }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    Assign Task
                </button>
            </form>
            {% endif %}
        </div>

        <!-- Jobs Table -->
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job ID</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completed By</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completed At</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rejections</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y">
                {% for job in task_jobs %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-800 font-mono">{{ job.cvat_job_id }}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">{{ job.completed_by_username or '-' }}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        {{ job.completed_at.strftime('%Y-%m-%d %H:%M') if job.completed_at else '-' }}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded status-{{ job.status.value }}">
                            {{ job.status.value.replace('_', ' ').title() }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        {% if job.rejection_count and job.rejection_count > 0 %}
                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium" title="{{ job.last_rejection_notes or 'No notes' }}">
                            {{ job.rejection_count }}x rejected
                        </span>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        {% if job.assigned_to_user %}
                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                            {{ job.assigned_to_user.username }}
                        </span>
                        {% else %}
                        <span class="text-gray-400">Unassigned</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-right">
                        {% if user.is_admin %}
                            <div class="flex items-center justify-end gap-2">
                                <!-- Assignment dropdown -->
                                <form method="POST" action="/queue/{{ job.id }}/assign" class="inline-flex items-center gap-1">
                                    <select name="reviewer_id" required class="text-sm px-2 py-1 border rounded focus:ring-1 focus:ring-indigo-500">
                                        <option value="">Assign...</option>
                                        {% for u in all_users %}
                                        <option value="{{ u.id }}" {% if job.assigned_to == u.id %}selected{% endif %}>{{ u.username }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="px-2 py-1 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                        Assign
                                    </button>
                                </form>

                                {% if job.status.value == 'pending' %}
                                <button type="button"
                                        onclick="startReview({{ job.id }})"
                                        class="text-indigo-600 hover:text-indigo-800 text-sm">
                                    Take
                                </button>
                                {% elif job.status.value == 'in_review' %}
                                <form method="POST" action="/queue/{{ job.id }}/validate" class="inline">
                                    <input type="hidden" name="action" value="validate">
                                    <input type="hidden" name="notes" value="">
                                    <button type="submit" class="text-green-600 hover:text-green-800 text-sm">
                                        Approve
                                    </button>
                                </form>
                                <form method="POST" action="/queue/{{ job.id }}/validate" class="inline">
                                    <input type="hidden" name="action" value="reject">
                                    <input type="hidden" name="notes" value="">
                                    <button type="submit" class="text-red-600 hover:text-red-800 text-sm">
                                        Reject
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        {% elif job.assigned_to == user.id %}
                            <!-- User is assigned to this job -->
                            {% if job.status.value == 'pending' %}
                            <button type="button"
                                    onclick="startReview({{ job.id }})"
                                    class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                Start Review
                            </button>
                            {% elif job.status.value == 'in_review' %}
                            <div class="flex items-center gap-2">
                                <a href="{{ job.cvat_host.rstrip('/') }}/tasks/{{ job.cvat_task_id }}/jobs/{{ job.cvat_job_id }}"
                                   target="_blank"
                                   class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">
                                    Open in CVAT
                                </a>
                                <form method="POST" action="/queue/{{ job.id }}/validate" class="inline">
                                    <input type="hidden" name="action" value="validate">
                                    <input type="hidden" name="notes" value="">
                                    <button type="submit" class="text-green-600 hover:text-green-800 text-sm">
                                        Approve
                                    </button>
                                </form>
                                <form method="POST" action="/queue/{{ job.id }}/validate" class="inline">
                                    <input type="hidden" name="action" value="reject">
                                    <input type="hidden" name="notes" value="">
                                    <button type="submit" class="text-red-600 hover:text-red-800 text-sm">
                                        Reject
                                    </button>
                                </form>
                            </div>
                            {% else %}
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
                                Assigned to you
                            </span>
                            {% endif %}
                        {% else %}
                            <span class="text-gray-400 text-sm">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
{% else %}
<div class="bg-white rounded-lg shadow">
    <div class="px-4 py-8 text-center text-gray-500">
        {% if user.is_admin %}
        No jobs pending validation.
        {% else %}
        No jobs assigned to you.
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Summary Stats -->
{% if jobs_by_task %}
<div class="mt-6 grid grid-cols-4 gap-4">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-gray-800">{{ total_jobs }}</div>
        <div class="text-sm text-gray-500">Total Jobs</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-amber-600">{{ pending_count }}</div>
        <div class="text-sm text-gray-500">Pending</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-blue-600">{{ assigned_count }}</div>
        <div class="text-sm text-gray-500">Assigned</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-purple-600">{{ jobs_by_task | length }}</div>
        <div class="text-sm text-gray-500">Tasks</div>
    </div>
</div>
{% endif %}

<script>
async function startReview(jobId) {
    try {
        const response = await fetch(`/queue/${jobId}/take`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'fetch'
            }
        });

        const data = await response.json();

        if (response.ok && data.cvat_url) {
            // Show modal with CVAT link from API response
            showCvatModal(data.cvat_url);
        } else {
            alert(data.error || 'Failed to start review');
        }
    } catch (error) {
        console.error('Error starting review:', error);
        alert('An error occurred while starting review');
    }
}

function showCvatModal(cvatUrl) {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'cvat-modal';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    overlay.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Job Ready for Review</h3>
            <p class="text-gray-600 mb-4">The job status has been updated. Click the button below to open it in CVAT:</p>
            <div class="flex flex-col gap-3">
                <a href="${cvatUrl}" target="_blank"
                   class="w-full px-4 py-2 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700 transition">
                    Open Job in CVAT
                </a>
                <button onclick="closeCvatModal()"
                        class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    Close & Refresh
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);
}

function closeCvatModal() {
    const modal = document.getElementById('cvat-modal');
    if (modal) modal.remove();
    window.location.reload();
}
</script>
{% endblock %}
