{% extends "base.html" %}
{% block title %}User Management - CVAT Queue{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">User Management</h1>
    <p class="text-gray-500">Manage user roles and permissions</p>
</div>

<!-- Reviewer Statistics Section -->
{% if reviewer_stats and reviewer_stats|length > 0 %}
<div class="apple-card mb-8">
    <div class="apple-card-header cursor-pointer select-none" onclick="toggleReviewerStats()" id="reviewer-stats-header">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-3">
                <h2>Reviewer Statistics</h2>
                <span class="apple-badge apple-badge-info">{{ reviewer_stats|length }} reviewers</span>
            </div>
            <button type="button" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                <span id="reviewer-toggle-text">Hide</span>
                <svg id="reviewer-chevron" class="w-5 h-5 transition-transform duration-200" style="transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="reviewer-stats-content">
        <div class="apple-table-container">
            <table class="apple-table">
                <thead>
                    <tr>
                        <th>Reviewer</th>
                        <th class="text-center">Role</th>
                        <th class="text-center">Total Reviews</th>
                        <th class="text-center">
                            <span class="inline-flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                Accepted
                            </span>
                        </th>
                        <th class="text-center">
                            <span class="inline-flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-red-400"></span>
                                Rejected
                            </span>
                        </th>
                        <th class="text-center">Accept Rate</th>
                        <th class="text-center">Today</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reviewer in reviewer_stats %}
                    <tr>
                        <td>
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br {% if reviewer.is_admin %}from-purple-500 to-indigo-600{% else %}from-blue-500 to-cyan-600{% endif %} flex items-center justify-center text-white font-semibold text-xs shadow-sm">
                                    {{ reviewer.username[0]|upper }}{{ reviewer.username[1]|upper if reviewer.username|length > 1 else '' }}
                                </div>
                                <span class="font-medium text-gray-900">{{ reviewer.username }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if reviewer.is_admin %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                                Admin
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                User
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-center font-semibold">{{ reviewer.total_reviews }}</td>
                        <td class="text-center">
                            {% if reviewer.validated > 0 %}
                            <span class="inline-flex items-center justify-center min-w-[24px] px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                {{ reviewer.validated }}
                            </span>
                            {% else %}
                            <span class="text-gray-300">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if reviewer.rejected > 0 %}
                            <span class="inline-flex items-center justify-center min-w-[24px] px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                {{ reviewer.rejected }}
                            </span>
                            {% else %}
                            <span class="text-gray-300">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full {% if reviewer.approval_rate >= 80 %}bg-green-500{% elif reviewer.approval_rate >= 50 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                         style="width: {{ reviewer.approval_rate }}%"></div>
                                </div>
                                <span class="text-xs font-medium {% if reviewer.approval_rate >= 80 %}text-green-600{% elif reviewer.approval_rate >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    {{ "%.0f"|format(reviewer.approval_rate) }}%
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if reviewer.today_reviews > 0 %}
                            <div class="flex items-center justify-center gap-1">
                                <span class="text-xs text-green-600 font-medium">{{ reviewer.today_validated }}</span>
                                <span class="text-gray-300">/</span>
                                <span class="text-xs text-red-600 font-medium">{{ reviewer.today_rejected }}</span>
                            </div>
                            {% else %}
                            <span class="text-gray-300">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50/50">
            <div class="flex items-center justify-between text-sm text-gray-500">
                <span>
                    Total: {{ reviewer_stats|sum(attribute='total_reviews') }} reviews
                    ({{ reviewer_stats|sum(attribute='validated') }} accepted, {{ reviewer_stats|sum(attribute='rejected') }} rejected)
                </span>
                <span class="text-xs">
                    Today: {{ reviewer_stats|sum(attribute='today_reviews') }} reviews
                </span>
            </div>
        </div>
    </div>
</div>

<script>
function toggleReviewerStats() {
    const content = document.getElementById('reviewer-stats-content');
    const chevron = document.getElementById('reviewer-chevron');
    const toggleText = document.getElementById('reviewer-toggle-text');

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
        toggleText.textContent = 'Hide';
        localStorage.setItem('reviewerStatsExpanded', 'true');
    } else {
        content.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
        toggleText.textContent = 'Show';
        localStorage.setItem('reviewerStatsExpanded', 'false');
    }
}

// Restore reviewer stats state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const expanded = localStorage.getItem('reviewerStatsExpanded');
    if (expanded === 'false') {
        const content = document.getElementById('reviewer-stats-content');
        const chevron = document.getElementById('reviewer-chevron');
        const toggleText = document.getElementById('reviewer-toggle-text');
        if (content) {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
            toggleText.textContent = 'Show';
        }
    }
});
</script>
{% endif %}

<!-- User Management Table -->
<div class="bg-white rounded-lg shadow">
    {% if users %}
    <table class="w-full">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CVAT Host</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y">
            {% for u in users %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-600">{{ u.id }}</td>
                <td class="px-4 py-3 text-sm font-medium text-gray-800">
                    {{ u.username }}
                    {% if u.id == user.id %}
                    <span class="ml-1 text-xs text-gray-400">(you)</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">{{ u.cvat_host }}</td>
                <td class="px-4 py-3">
                    {% if u.is_admin %}
                    <span class="px-2 py-1 text-xs rounded bg-indigo-100 text-indigo-700">Admin</span>
                    {% else %}
                    <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-600">User</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-500">
                    {{ u.created_at.strftime('%Y-%m-%d') if u.created_at else '-' }}
                </td>
                <td class="px-4 py-3 text-right">
                    {% if u.id != user.id %}
                    <form method="POST" action="/admin/toggle/{{ u.id }}" class="inline">
                        <button type="submit" class="text-indigo-600 hover:text-indigo-800 text-sm">
                            {% if u.is_admin %}Remove Admin{% else %}Make Admin{% endif %}
                        </button>
                    </form>
                    {% else %}
                    <span class="text-gray-400 text-sm">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="px-4 py-8 text-center text-gray-500">
        No users found.
    </div>
    {% endif %}
</div>
{% endblock %}
