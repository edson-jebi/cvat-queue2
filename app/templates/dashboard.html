{% extends "base.html" %}
{% block title %}Dashboard - CVAT Queue{% endblock %}

{% block content %}
<div class="mb-10">
    <h1 class="apple-title-2 text-gray-900">Dashboard</h1>
    <p class="apple-subheadline text-gray-500 mt-2">Select a task to view its jobs</p>
</div>

{% if user.is_admin %}
<!-- Loading indicator for pending sync check -->
<div id="pending-sync-loading" class="apple-alert apple-alert-info mb-8">
    <div class="apple-alert-icon">
        <div class="sync-loader">
            <div class="sync-loader-dot"></div>
            <div class="sync-loader-dot"></div>
            <div class="sync-loader-dot"></div>
        </div>
    </div>
    <div class="apple-alert-content">
        <p class="apple-body font-medium">Checking for completed jobs...</p>
        <p class="apple-footnote text-gray-500 mt-1">Scanning tasks for jobs ready to sync</p>
    </div>
</div>

<!-- Dynamic alert for pending sync jobs (admin only) -->
<div id="pending-sync-alert" class="apple-alert apple-alert-warning mb-8" style="display: none;">
    <div class="apple-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
    </div>
    <div class="apple-alert-content">
        <p class="apple-body">
            <span id="pending-sync-count" class="font-semibold">0</span> completed job(s) ready for queue sync
        </p>
        <p id="pending-sync-details" class="apple-footnote text-gray-500 mt-1"></p>
    </div>
    <div class="flex gap-2">
        <button onclick="syncAllPending()" id="sync-all-btn" class="apple-btn apple-btn-sm apple-btn-primary" title="Sync All">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Sync All
        </button>
        <button onclick="refreshPendingCheck()" class="apple-btn apple-btn-sm apple-btn-ghost" title="Refresh">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>
</div>
{% endif %}

{% if pending_count > 0 %}
<div class="apple-alert apple-alert-info mb-8">
    <div class="apple-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
    </div>
    <div class="apple-alert-content">
        <p class="apple-body">
            <span class="font-semibold">{{ pending_count }}</span> job(s) waiting for validation
        </p>
    </div>
    <a href="/queue" class="apple-btn apple-btn-sm apple-btn-secondary">
        View Queue
    </a>
</div>
{% endif %}

<!-- Queue Activity by Task with Project Sankey (shown first) -->
{% if top_tasks %}
<div class="apple-card">
    <div class="apple-card-header">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-3">
                <h2>Queue Activity by Task</h2>
                <span class="apple-badge apple-badge-info">Top {{ top_tasks|length }}</span>
            </div>
            <div class="flex items-center gap-2">
                <label for="task-limit" class="text-sm text-gray-500">Show:</label>
                <select id="task-limit" class="apple-select text-sm" style="width: auto; padding: 4px 24px 4px 10px;" onchange="filterTopTasks()">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="25">25</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>
    </div>

    <div class="sankey-container">
        <!-- Projects Column (Left) -->
        <div class="sankey-projects">
            <div class="sankey-column-header">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
                Projects
            </div>
            {% for project in projects_summary %}
            <div class="sankey-project-node"
                 data-project="{{ project.project_name }}"
                 data-task-ids="{{ project.task_ids|join(',') }}"
                 onmouseenter="highlightProject('{{ project.project_name }}')"
                 onmouseleave="clearHighlight()"
                 onclick="openProjectAnalytics('{{ project.project_name }}', '{{ project.task_ids|join(',') }}')">
                <div class="sankey-node-content">
                    <span class="sankey-node-name truncate">{{ project.project_name }}</span>
                    <div class="sankey-node-stats">
                        <span class="sankey-stat">{{ project.task_ids|length }} tasks</span>
                        <span class="sankey-stat">{{ project.total_jobs }} jobs</span>
                    </div>
                </div>
                <div class="sankey-node-bar" style="--bar-width: {{ (project.total_jobs / (projects_summary|map(attribute='total_jobs')|max or 1) * 100)|int }}%"></div>
                <div class="sankey-node-click-hint">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Connection Lines (SVG) -->
        <div class="sankey-connections" id="sankey-svg-container">
            <svg id="sankey-lines" width="100%" height="100%" preserveAspectRatio="none"></svg>
        </div>

        <!-- Tasks Table (Right) -->
        <div class="sankey-tasks">
            <div class="apple-table-container" style="border: none; border-radius: 0;">
                <table class="apple-table" id="top-tasks-table">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th class="text-center">Frames</th>
                            <th class="text-center">Jobs</th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                    Pend
                                </span>
                            </th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                                    Rev
                                </span>
                            </th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                    Val
                                </span>
                            </th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-red-400"></span>
                                    Rej
                                </span>
                            </th>
                            <th class="text-right">Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in top_tasks %}
                        <tr class="top-task-row"
                            data-index="{{ loop.index }}"
                            data-task-id="{{ task.task_id }}"
                            data-project="{{ task.project_name }}"
                            onmouseenter="highlightTask({{ task.task_id }}, '{{ task.project_name }}')"
                            onmouseleave="clearHighlight()">
                            <td>
                                <a href="/task/{{ task.task_id }}" class="font-medium text-blue-600 hover:text-blue-800 hover:underline">
                                    {{ task.task_name }}
                                </a>
                                <span class="text-xs text-gray-400 ml-1">#{{ task.task_id }}</span>
                            </td>
                            <td class="text-center">
                                {% if task.frames > 0 %}
                                <span class="text-gray-600 text-sm">{{ "{:,}".format(task.frames) }}</span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center font-semibold">{{ task.total_jobs }}</td>
                            <td class="text-center">
                                {% if task.pending > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
                                    {{ task.pending }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if task.in_review > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                    {{ task.in_review }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if task.validated > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                    {{ task.validated }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if task.rejected > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                    {{ task.rejected }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right" style="min-width: 100px;">
                                {% set completed = task.validated + task.rejected %}
                                {% set progress = (completed / task.total_jobs * 100) if task.total_jobs > 0 else 0 %}
                                <div class="flex items-center justify-end gap-2">
                                    <div class="apple-progress" style="width: 50px; height: 5px;">
                                        <div class="apple-progress-bar {% if progress == 100 %}apple-progress-bar-green{% elif progress >= 50 %}apple-progress-bar-blue{% else %}apple-progress-bar-yellow{% endif %}" style="width: {{ progress }}%;"></div>
                                    </div>
                                    <span class="text-xs text-gray-500 w-8 text-right">{{ progress|round|int }}%</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="p-4 border-t border-gray-100 bg-gray-50/50">
        <div class="flex items-center justify-between text-sm text-gray-500">
            <span>
                Showing <span id="visible-count">{{ top_tasks|length }}</span> of {{ top_tasks|length }} tasks with queue activity
            </span>
            <span class="text-xs">
                Click on a project to view label analytics
            </span>
        </div>
    </div>
</div>

<!-- Project Analytics Modal -->
<div class="project-modal-overlay" id="project-analytics-modal" onclick="closeProjectAnalyticsOnOverlay(event)">
    <div class="project-modal">
        <div class="project-modal-header">
            <div class="project-modal-title">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span id="project-modal-project-name">Project Analytics</span>
            </div>
            <div class="project-modal-close" onclick="closeProjectAnalytics()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
        </div>
        <div class="project-modal-body" id="project-modal-content">
            <div class="project-modal-loading">
                <div class="spinner"></div>
                <p class="mt-3">Loading analytics...</p>
                <p class="text-xs mt-1">Fetching label statistics for all jobs</p>
            </div>
        </div>
    </div>
</div>

<style>
.sankey-container {
    display: flex;
    min-height: 400px;
    overflow: hidden;
}

.sankey-projects {
    width: 220px;
    flex-shrink: 0;
    padding: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-right: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.sankey-column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 0.5rem;
}

.sankey-project-node {
    position: relative;
    padding: 0.75rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
}

.sankey-project-node:hover,
.sankey-project-node.highlighted {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateX(4px);
}

.sankey-project-node.dimmed {
    opacity: 0.4;
}

.sankey-node-content {
    position: relative;
    z-index: 1;
}

.sankey-node-name {
    display: block;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.sankey-node-stats {
    display: flex;
    gap: 0.75rem;
}

.sankey-stat {
    font-size: 0.6875rem;
    color: #64748b;
}

.sankey-node-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    width: var(--bar-width, 0%);
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
    border-radius: 0 3px 0 0;
}

.sankey-connections {
    width: 60px;
    flex-shrink: 0;
    position: relative;
}

#sankey-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.sankey-line {
    fill: none;
    stroke: #cbd5e1;
    stroke-width: 2;
    opacity: 0.5;
    transition: all 0.2s ease;
}

.sankey-line.highlighted {
    stroke: #3b82f6;
    stroke-width: 3;
    opacity: 1;
}

.sankey-line.dimmed {
    opacity: 0.1;
}

.sankey-tasks {
    flex: 1;
    overflow-x: auto;
}

.sankey-tasks .apple-table-container {
    border-radius: 0;
}

.top-task-row {
    transition: all 0.2s ease;
}

.top-task-row.highlighted {
    background: rgba(59, 130, 246, 0.08) !important;
}

.top-task-row.dimmed {
    opacity: 0.4;
}

.top-task-row.highlighted td:first-child {
    position: relative;
}

.top-task-row.highlighted td:first-child::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: #3b82f6;
}

.sankey-node-click-hint {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease;
    color: #94a3b8;
}

.sankey-project-node:hover .sankey-node-click-hint {
    opacity: 1;
}

/* Project Analytics Modal */
.project-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.project-modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.project-modal {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    max-width: 900px;
    width: 95%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    transform: scale(0.95) translateY(20px);
    transition: transform 0.3s ease;
}

.project-modal-overlay.active .project-modal {
    transform: scale(1) translateY(0);
}

.project-modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.project-modal-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.project-modal-close {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64748b;
    transition: all 0.2s ease;
    cursor: pointer;
}

.project-modal-close:hover {
    background: #f1f5f9;
    color: #1e293b;
}

.project-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.project-modal-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #64748b;
}

.project-modal-loading .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Label Tree Styles */
.label-tree {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.label-tree-item {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s ease;
}

.label-tree-item:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.label-tree-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    cursor: pointer;
    user-select: none;
}

.label-tree-header:hover {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
}

.label-tree-chevron {
    width: 20px;
    height: 20px;
    color: #64748b;
    transition: transform 0.2s ease;
    flex-shrink: 0;
}

.label-tree-item.expanded .label-tree-chevron {
    transform: rotate(90deg);
}

.label-tree-label-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.label-tree-label-name {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.875rem;
}

.label-tree-label-count {
    font-size: 0.75rem;
    color: #64748b;
    background: white;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    border: 1px solid #e2e8f0;
}

.label-tree-jobs-badge {
    font-size: 0.6875rem;
    color: #3b82f6;
    background: #eff6ff;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-weight: 500;
}

.label-tree-bar {
    width: 80px;
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
    flex-shrink: 0;
}

.label-tree-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.label-tree-content {
    display: none;
    border-top: 1px solid #e2e8f0;
}

.label-tree-item.expanded .label-tree-content {
    display: block;
}

.label-tree-jobs {
    padding: 0.75rem;
    background: #fafafa;
}

.label-tree-job {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.label-tree-job:last-child {
    margin-bottom: 0;
}

.label-tree-job:hover {
    border-color: #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
}

.label-tree-job-id {
    font-weight: 600;
    color: #3b82f6;
    font-size: 0.8125rem;
    min-width: 70px;
}

.label-tree-job-task {
    flex: 1;
    font-size: 0.75rem;
    color: #64748b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.label-tree-job-assignee {
    font-size: 0.75rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.label-tree-job-annotations {
    font-size: 0.75rem;
    font-weight: 500;
    color: #059669;
    background: #ecfdf5;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.label-tree-job-labels {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    max-width: 200px;
}

.label-tree-job-label-tag {
    font-size: 0.625rem;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    background: #f1f5f9;
    color: #475569;
    white-space: nowrap;
}

.label-tree-job-label-tag.primary {
    background: #dbeafe;
    color: #1d4ed8;
    font-weight: 500;
}

/* Summary stats */
.project-analytics-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.project-summary-stat {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
}

.project-summary-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.project-summary-stat-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.25rem;
}

.project-summary-stat.highlight {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #bfdbfe;
}

.project-summary-stat.highlight .project-summary-stat-value {
    color: #1d4ed8;
}

.project-summary-stat.highlight-green {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-color: #bbf7d0;
}

.project-summary-stat.highlight-green .project-summary-stat-value {
    color: #16a34a;
}

.project-summary-stat-sub {
    font-size: 0.7rem;
    color: #16a34a;
    font-weight: 600;
    margin-top: 0.125rem;
}

/* Query Builder Styles */
.query-builder-section {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.query-builder-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
}

.query-builder-body {
    padding: 1rem;
}

.query-row {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.875rem;
}

.query-row:last-child {
    margin-bottom: 0;
}

.query-label {
    min-width: 100px;
    font-size: 0.8125rem;
    font-weight: 500;
    color: #64748b;
    padding-top: 0.5rem;
}

.query-select {
    flex: 1;
    max-width: 300px;
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    font-size: 0.8125rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") no-repeat right 0.5rem center/1.25em;
    appearance: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.query-select:hover {
    border-color: #cbd5e1;
}

.query-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.query-select-small {
    max-width: 150px;
}

.query-labels-container {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    max-height: 150px;
    overflow-y: auto;
    padding: 0.5rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.query-label-chip {
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    color: #475569;
}

.query-label-chip:hover {
    border-color: #3b82f6;
    color: #3b82f6;
}

.query-label-chip.selected {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
}

.query-selected-labels {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
}

.query-selected-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    background: #dbeafe;
    color: #1d4ed8;
    border-radius: 6px;
    font-weight: 500;
}

.query-selected-tag-remove {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(29, 78, 216, 0.2);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.875rem;
    line-height: 1;
    color: inherit;
    transition: background 0.15s ease;
}

.query-selected-tag-remove:hover {
    background: rgba(29, 78, 216, 0.3);
}

.query-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

.query-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.query-btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
}

.query-btn-primary:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.query-btn-secondary {
    background: white;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.query-btn-secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

/* Query Results Styles */
.query-results {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
}

.query-results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
}

.query-results-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #1e293b;
}

.query-results-count {
    font-size: 0.75rem;
    color: #64748b;
}

.query-results-body {
    max-height: 400px;
    overflow-y: auto;
}

.query-results-placeholder {
    padding: 3rem;
    text-align: center;
}

.query-results-table-container {
    overflow-x: auto;
}

.query-results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8125rem;
}

.query-results-table th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #64748b;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.query-results-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
}

.query-result-row:hover {
    background: #f8fafc;
}

.query-job-link {
    font-weight: 600;
    color: #3b82f6;
    text-decoration: none;
}

.query-job-link:hover {
    text-decoration: underline;
}

.query-task-name {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #64748b;
}

.query-assignee {
    color: #64748b;
}

.query-selected-count {
    font-weight: 600;
    color: #3b82f6;
}

.query-total-count {
    color: #64748b;
}

.query-label-breakdown {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.query-breakdown-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: #f1f5f9;
    border-radius: 4px;
    font-size: 0.6875rem;
}

.query-breakdown-name {
    color: #475569;
    max-width: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.query-breakdown-count {
    font-weight: 600;
    color: #3b82f6;
}

.query-breakdown-more {
    font-size: 0.625rem;
    color: #94a3b8;
    padding: 0.25rem;
}
</style>

<script>
// Draw initial connection lines
function drawSankeyLines() {
    const svg = document.getElementById('sankey-lines');
    if (!svg) return;

    const container = document.getElementById('sankey-svg-container');
    const projects = document.querySelectorAll('.sankey-project-node');
    const tasks = document.querySelectorAll('.top-task-row');

    svg.innerHTML = '';

    const containerRect = container.getBoundingClientRect();

    projects.forEach(project => {
        const projectName = project.dataset.project;
        const taskIds = project.dataset.taskIds.split(',').map(id => id.trim());
        const projectRect = project.getBoundingClientRect();

        taskIds.forEach(taskId => {
            const taskRow = document.querySelector(`.top-task-row[data-task-id="${taskId}"]`);
            if (taskRow && taskRow.style.display !== 'none') {
                const taskRect = taskRow.getBoundingClientRect();

                const x1 = 0;
                const y1 = projectRect.top + projectRect.height / 2 - containerRect.top;
                const x2 = 60;
                const y2 = taskRect.top + taskRect.height / 2 - containerRect.top;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = 30;
                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                path.setAttribute('class', 'sankey-line');
                path.setAttribute('data-project', projectName);
                path.setAttribute('data-task-id', taskId);
                svg.appendChild(path);
            }
        });
    });
}

function highlightProject(projectName) {
    // Highlight project node
    document.querySelectorAll('.sankey-project-node').forEach(node => {
        if (node.dataset.project === projectName) {
            node.classList.add('highlighted');
            node.classList.remove('dimmed');
        } else {
            node.classList.add('dimmed');
            node.classList.remove('highlighted');
        }
    });

    // Highlight related tasks
    document.querySelectorAll('.top-task-row').forEach(row => {
        if (row.dataset.project === projectName && row.style.display !== 'none') {
            row.classList.add('highlighted');
            row.classList.remove('dimmed');
        } else {
            row.classList.add('dimmed');
            row.classList.remove('highlighted');
        }
    });

    // Highlight connection lines
    document.querySelectorAll('.sankey-line').forEach(line => {
        if (line.dataset.project === projectName) {
            line.classList.add('highlighted');
            line.classList.remove('dimmed');
        } else {
            line.classList.add('dimmed');
            line.classList.remove('highlighted');
        }
    });
}

function highlightTask(taskId, projectName) {
    // Highlight task row
    document.querySelectorAll('.top-task-row').forEach(row => {
        if (row.dataset.taskId == taskId) {
            row.classList.add('highlighted');
            row.classList.remove('dimmed');
        } else {
            row.classList.add('dimmed');
            row.classList.remove('highlighted');
        }
    });

    // Highlight parent project
    document.querySelectorAll('.sankey-project-node').forEach(node => {
        if (node.dataset.project === projectName) {
            node.classList.add('highlighted');
            node.classList.remove('dimmed');
        } else {
            node.classList.add('dimmed');
            node.classList.remove('highlighted');
        }
    });

    // Highlight connection line
    document.querySelectorAll('.sankey-line').forEach(line => {
        if (line.dataset.taskId == taskId) {
            line.classList.add('highlighted');
            line.classList.remove('dimmed');
        } else {
            line.classList.add('dimmed');
            line.classList.remove('highlighted');
        }
    });
}

function clearHighlight() {
    document.querySelectorAll('.sankey-project-node, .top-task-row, .sankey-line').forEach(el => {
        el.classList.remove('highlighted', 'dimmed');
    });
}

function filterTopTasks() {
    const limit = document.getElementById('task-limit').value;
    const rows = document.querySelectorAll('.top-task-row');
    let visibleCount = 0;

    rows.forEach((row, index) => {
        if (limit === 'all' || index < parseInt(limit)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    document.getElementById('visible-count').textContent = visibleCount;

    // Redraw Sankey lines after filtering
    setTimeout(drawSankeyLines, 50);
}

// Initialize Sankey lines on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(drawSankeyLines, 100);
});

// Redraw on window resize
window.addEventListener('resize', function() {
    clearTimeout(window.sankeyResizeTimeout);
    window.sankeyResizeTimeout = setTimeout(drawSankeyLines, 100);
});

// Project Analytics Modal Functions
function openProjectAnalytics(projectName, allTaskIds) {
    const modal = document.getElementById('project-analytics-modal');
    const titleEl = document.getElementById('project-modal-project-name');
    const contentEl = document.getElementById('project-modal-content');

    // Get only the visible task IDs for this project (filtered by task limit)
    const allTaskIdsList = allTaskIds.split(',').map(id => id.trim());
    const visibleTaskIds = [];

    // Check which tasks from this project are currently visible
    allTaskIdsList.forEach(taskId => {
        const taskRow = document.querySelector(`.top-task-row[data-task-id="${taskId}"]`);
        if (taskRow && taskRow.style.display !== 'none') {
            visibleTaskIds.push(taskId);
        }
    });

    // Use visible tasks, or fall back to all if none visible
    const taskIdsToFetch = visibleTaskIds.length > 0 ? visibleTaskIds.join(',') : allTaskIds;
    const taskCount = visibleTaskIds.length > 0 ? visibleTaskIds.length : allTaskIdsList.length;

    // Set title and show loading
    titleEl.textContent = projectName + ' - Label Analytics';
    contentEl.innerHTML = `
        <div class="project-modal-loading">
            <div class="spinner"></div>
            <p class="mt-3">Loading analytics...</p>
            <p class="text-xs mt-1">Fetching data for ${taskCount} visible task(s)</p>
        </div>
    `;

    // Show modal
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Fetch analytics data for visible tasks only
    fetch(`/api/project/${encodeURIComponent(projectName)}/analytics?task_ids=${taskIdsToFetch}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                contentEl.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <p class="font-medium">Error loading analytics</p>
                        <p class="text-sm mt-1">${data.error}</p>
                    </div>
                `;
                return;
            }

            renderProjectAnalytics(data);
        })
        .catch(error => {
            contentEl.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <p class="font-medium">Failed to load analytics</p>
                    <p class="text-sm mt-1">${error.message}</p>
                </div>
            `;
        });
}

// Global variable to store analytics data for querying
let currentAnalyticsData = null;

function renderProjectAnalytics(data) {
    const contentEl = document.getElementById('project-modal-content');
    currentAnalyticsData = data;

    // Extract all unique labels from all jobs
    const allLabels = new Set();
    data.tasks.forEach(task => {
        task.jobs.forEach(job => {
            Object.keys(job.all_labels).forEach(label => allLabels.add(label));
        });
    });
    const sortedLabels = Array.from(allLabels).sort();

    // Calculate validated percentage
    const validatedPct = data.total_frames > 0 ? ((data.validated_frames / data.total_frames) * 100).toFixed(1) : 0;

    let html = `
        <!-- Summary Stats -->
        <div class="project-analytics-summary">
            <div class="project-summary-stat">
                <div class="project-summary-stat-value">${data.tasks_count}</div>
                <div class="project-summary-stat-label">Tasks</div>
            </div>
            <div class="project-summary-stat">
                <div class="project-summary-stat-value">${data.total_jobs}</div>
                <div class="project-summary-stat-label">Jobs</div>
            </div>
            <div class="project-summary-stat">
                <div class="project-summary-stat-value">${data.total_frames.toLocaleString()}</div>
                <div class="project-summary-stat-label">Total Frames</div>
            </div>
            <div class="project-summary-stat highlight-green">
                <div class="project-summary-stat-value">${data.validated_frames.toLocaleString()}</div>
                <div class="project-summary-stat-label">Validated Frames</div>
                <div class="project-summary-stat-sub">${validatedPct}%</div>
            </div>
            <div class="project-summary-stat highlight">
                <div class="project-summary-stat-value">${data.total_annotations.toLocaleString()}</div>
                <div class="project-summary-stat-label">Total Annotations</div>
            </div>
            <div class="project-summary-stat">
                <div class="project-summary-stat-value">${sortedLabels.length}</div>
                <div class="project-summary-stat-label">Labels</div>
            </div>
        </div>

        <!-- Query Builder Section -->
        <div class="query-builder-section">
            <div class="query-builder-header">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Label Query Tool</h3>
                </div>
                <span class="text-xs text-gray-500">Find jobs by label combinations</span>
            </div>

            <div class="query-builder-body">
                <!-- Query Type Selection -->
                <div class="query-row">
                    <label class="query-label">Find jobs where</label>
                    <select id="query-type" class="query-select" onchange="updateQueryUI()">
                        <option value="most_common">labels are MOST common</option>
                        <option value="least_common">labels are LEAST common</option>
                        <option value="has_all">jobs have ALL selected labels</option>
                        <option value="has_any">jobs have ANY of selected labels</option>
                        <option value="dominant">dominant label is</option>
                    </select>
                </div>

                <!-- Label Selection -->
                <div class="query-row">
                    <label class="query-label">Labels</label>
                    <div class="query-labels-container" id="query-labels-container">
                        ${sortedLabels.map(label => `
                            <button type="button" class="query-label-chip" data-label="${escapeHtml(label)}" onclick="toggleLabelSelection(this)">
                                ${escapeHtml(label)}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Selected Labels Display -->
                <div class="query-row" id="selected-labels-row" style="display: none;">
                    <label class="query-label">Selected</label>
                    <div class="query-selected-labels" id="query-selected-labels"></div>
                </div>

                <!-- Sort Options -->
                <div class="query-row">
                    <label class="query-label">Sort by</label>
                    <select id="query-sort" class="query-select">
                        <option value="total_desc">Total annotations (high to low)</option>
                        <option value="total_asc">Total annotations (low to high)</option>
                        <option value="selected_desc">Selected label count (high to low)</option>
                        <option value="selected_asc">Selected label count (low to high)</option>
                        <option value="job_id">Job ID</option>
                    </select>
                </div>

                <!-- Limit -->
                <div class="query-row">
                    <label class="query-label">Show</label>
                    <select id="query-limit" class="query-select query-select-small">
                        <option value="10">10 jobs</option>
                        <option value="25" selected>25 jobs</option>
                        <option value="50">50 jobs</option>
                        <option value="100">100 jobs</option>
                        <option value="all">All jobs</option>
                    </select>
                </div>

                <!-- Execute Query Button -->
                <div class="query-actions">
                    <button type="button" class="query-btn query-btn-secondary" onclick="clearQuerySelection()">
                        Clear
                    </button>
                    <button type="button" class="query-btn query-btn-primary" onclick="executeQuery()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Run Query
                    </button>
                </div>
            </div>
        </div>

        <!-- Query Results -->
        <div class="query-results" id="query-results">
            <div class="query-results-header">
                <span class="query-results-title">Results</span>
                <span class="query-results-count" id="query-results-count">Select labels and run query</span>
            </div>
            <div class="query-results-body" id="query-results-body">
                <div class="query-results-placeholder">
                    <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-gray-500 text-sm">Select one or more labels and click "Run Query"</p>
                    <p class="text-gray-400 text-xs mt-1">Results will show jobs matching your criteria</p>
                </div>
            </div>
        </div>
    `;

    contentEl.innerHTML = html;
}

function toggleLabelSelection(chip) {
    chip.classList.toggle('selected');
    updateSelectedLabelsDisplay();
}

function updateSelectedLabelsDisplay() {
    const selectedChips = document.querySelectorAll('.query-label-chip.selected');
    const selectedLabelsRow = document.getElementById('selected-labels-row');
    const selectedLabelsContainer = document.getElementById('query-selected-labels');

    if (selectedChips.length > 0) {
        selectedLabelsRow.style.display = '';
        selectedLabelsContainer.innerHTML = Array.from(selectedChips).map(chip => `
            <span class="query-selected-tag">
                ${escapeHtml(chip.dataset.label)}
                <button type="button" onclick="removeSelectedLabel('${escapeHtml(chip.dataset.label)}')" class="query-selected-tag-remove">Ã—</button>
            </span>
        `).join('');
    } else {
        selectedLabelsRow.style.display = 'none';
        selectedLabelsContainer.innerHTML = '';
    }
}

function removeSelectedLabel(label) {
    const chip = document.querySelector(`.query-label-chip[data-label="${label}"]`);
    if (chip) {
        chip.classList.remove('selected');
        updateSelectedLabelsDisplay();
    }
}

function clearQuerySelection() {
    document.querySelectorAll('.query-label-chip.selected').forEach(chip => {
        chip.classList.remove('selected');
    });
    updateSelectedLabelsDisplay();

    // Reset results
    document.getElementById('query-results-count').textContent = 'Select labels and run query';
    document.getElementById('query-results-body').innerHTML = `
        <div class="query-results-placeholder">
            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-gray-500 text-sm">Select one or more labels and click "Run Query"</p>
            <p class="text-gray-400 text-xs mt-1">Results will show jobs matching your criteria</p>
        </div>
    `;
}

function updateQueryUI() {
    // Future: can show/hide options based on query type
}

function executeQuery() {
    if (!currentAnalyticsData) return;

    const selectedLabels = Array.from(document.querySelectorAll('.query-label-chip.selected'))
        .map(chip => chip.dataset.label);

    if (selectedLabels.length === 0) {
        document.getElementById('query-results-count').textContent = 'Please select at least one label';
        return;
    }

    const queryType = document.getElementById('query-type').value;
    const sortBy = document.getElementById('query-sort').value;
    const limitValue = document.getElementById('query-limit').value;

    // Collect all jobs
    let allJobs = [];
    currentAnalyticsData.tasks.forEach(task => {
        task.jobs.forEach(job => {
            allJobs.push(job);
        });
    });

    // Filter based on query type
    let filteredJobs = [];

    switch (queryType) {
        case 'most_common':
        case 'least_common':
            // For these, we show all jobs but sort by selected labels count
            filteredJobs = allJobs.filter(job => {
                // Job must have at least one of the selected labels
                return selectedLabels.some(label => (job.all_labels[label] || 0) > 0);
            });
            break;

        case 'has_all':
            // Jobs must have ALL selected labels
            filteredJobs = allJobs.filter(job => {
                return selectedLabels.every(label => (job.all_labels[label] || 0) > 0);
            });
            break;

        case 'has_any':
            // Jobs must have ANY of selected labels
            filteredJobs = allJobs.filter(job => {
                return selectedLabels.some(label => (job.all_labels[label] || 0) > 0);
            });
            break;

        case 'dominant':
            // Jobs where dominant label is one of selected
            filteredJobs = allJobs.filter(job => {
                const sortedLabels = Object.entries(job.all_labels).sort((a, b) => b[1] - a[1]);
                if (sortedLabels.length === 0) return false;
                const dominantLabel = sortedLabels[0][0];
                return selectedLabels.includes(dominantLabel);
            });
            break;
    }

    // Calculate selected labels total for each job
    filteredJobs = filteredJobs.map(job => {
        const selectedTotal = selectedLabels.reduce((sum, label) => sum + (job.all_labels[label] || 0), 0);
        return { ...job, selectedLabelsTotal: selectedTotal };
    });

    // Sort
    switch (sortBy) {
        case 'total_desc':
            filteredJobs.sort((a, b) => b.total_annotations - a.total_annotations);
            break;
        case 'total_asc':
            filteredJobs.sort((a, b) => a.total_annotations - b.total_annotations);
            break;
        case 'selected_desc':
            filteredJobs.sort((a, b) => b.selectedLabelsTotal - a.selectedLabelsTotal);
            break;
        case 'selected_asc':
            filteredJobs.sort((a, b) => a.selectedLabelsTotal - b.selectedLabelsTotal);
            break;
        case 'job_id':
            filteredJobs.sort((a, b) => a.job_id - b.job_id);
            break;
    }

    // For most_common/least_common, reverse if needed
    if (queryType === 'least_common') {
        filteredJobs.reverse();
    }

    // Apply limit
    const totalFound = filteredJobs.length;
    if (limitValue !== 'all') {
        filteredJobs = filteredJobs.slice(0, parseInt(limitValue));
    }

    // Render results
    renderQueryResults(filteredJobs, selectedLabels, totalFound);
}

function renderQueryResults(jobs, selectedLabels, totalFound) {
    const countEl = document.getElementById('query-results-count');
    const bodyEl = document.getElementById('query-results-body');

    countEl.textContent = `Found ${totalFound} jobs (showing ${jobs.length})`;

    if (jobs.length === 0) {
        bodyEl.innerHTML = `
            <div class="query-results-placeholder">
                <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-gray-500 text-sm">No jobs found matching your criteria</p>
                <p class="text-gray-400 text-xs mt-1">Try selecting different labels or changing the query type</p>
            </div>
        `;
        return;
    }

    bodyEl.innerHTML = `
        <div class="query-results-table-container">
            <table class="query-results-table">
                <thead>
                    <tr>
                        <th>Job</th>
                        <th>Task</th>
                        <th>Assignee</th>
                        <th class="text-right">Selected Labels</th>
                        <th class="text-right">Total</th>
                        <th>Label Breakdown</th>
                    </tr>
                </thead>
                <tbody>
                    ${jobs.map(job => {
                        // Get counts for selected labels
                        const labelBreakdown = selectedLabels.map(label => ({
                            name: label,
                            count: job.all_labels[label] || 0
                        })).filter(l => l.count > 0);

                        return `
                            <tr class="query-result-row">
                                <td>
                                    <a href="/task/${job.task_id}" class="query-job-link">
                                        Job #${job.job_id}
                                    </a>
                                </td>
                                <td class="query-task-name" title="${escapeHtml(job.task_name)}">
                                    ${escapeHtml(job.task_name)}
                                </td>
                                <td class="query-assignee">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        ${escapeHtml(job.assignee)}
                                    </span>
                                </td>
                                <td class="text-right">
                                    <span class="query-selected-count">${job.selectedLabelsTotal.toLocaleString()}</span>
                                </td>
                                <td class="text-right">
                                    <span class="query-total-count">${job.total_annotations.toLocaleString()}</span>
                                </td>
                                <td>
                                    <div class="query-label-breakdown">
                                        ${labelBreakdown.slice(0, 4).map(l => `
                                            <span class="query-breakdown-tag">
                                                <span class="query-breakdown-name">${escapeHtml(l.name)}</span>
                                                <span class="query-breakdown-count">${l.count}</span>
                                            </span>
                                        `).join('')}
                                        ${labelBreakdown.length > 4 ? `<span class="query-breakdown-more">+${labelBreakdown.length - 4}</span>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function closeProjectAnalytics() {
    const modal = document.getElementById('project-analytics-modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

function closeProjectAnalyticsOnOverlay(event) {
    if (event.target.id === 'project-analytics-modal') {
        closeProjectAnalytics();
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeProjectAnalytics();
    }
});
</script>
{% endif %}

<!-- Collapsible Your Tasks Section -->
<div class="apple-card mt-8">
    <div class="apple-card-header cursor-pointer select-none" onclick="toggleYourTasks()" id="your-tasks-header">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-3">
                <h2>Your Tasks</h2>
                {% if tasks %}
                <span class="apple-badge apple-badge-secondary">{{ tasks|length }}</span>
                {% endif %}
            </div>
            <button type="button" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                <span id="your-tasks-toggle-text">Show</span>
                <svg id="your-tasks-chevron" class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="your-tasks-content" class="hidden">
        {% if tasks %}
        <div class="apple-table-container">
            <table class="apple-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Size</th>
                        <th>Assignee</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="font-mono text-gray-500">{{ task.id }}</td>
                        <td class="font-medium">{{ task.name }}</td>
                        <td>
                            <span class="apple-badge apple-state-{{ task.status.lower().replace(' ', '_') }}">
                                {{ task.status }}
                            </span>
                        </td>
                        <td style="min-width: 140px;">
                            <div class="apple-progress-container">
                                <div class="apple-progress" style="flex: 1;">
                                    <div class="apple-progress-bar {% if task.progress_percent == 100 %}apple-progress-bar-green{% elif task.progress_percent >= 50 %}apple-progress-bar-blue{% else %}apple-progress-bar-yellow{% endif %}" style="width: {{ task.progress_percent }}%;"></div>
                                </div>
                                <span class="apple-progress-text">{{ task.progress_percent }}%</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">{{ task.completed_jobs_count }}/{{ task.jobs_count }} jobs</div>
                        </td>
                        <td class="text-gray-500">{{ task.size }} frames</td>
                        <td class="text-gray-500">{{ task.assignee or '-' }}</td>
                        <td class="text-right">
                            <a href="/task/{{ task.id }}" class="apple-btn apple-btn-ghost apple-btn-sm">
                                View Jobs
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="apple-empty-state">
            <div class="apple-empty-icon">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h3 class="apple-empty-heading">No Tasks Found</h3>
            <p class="apple-empty-text">
                Tasks will appear here once you have access in CVAT.<br>
                Contact your administrator if you need access.
            </p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleYourTasks() {
    const content = document.getElementById('your-tasks-content');
    const chevron = document.getElementById('your-tasks-chevron');
    const toggleText = document.getElementById('your-tasks-toggle-text');

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
        toggleText.textContent = 'Hide';
        localStorage.setItem('yourTasksExpanded', 'true');
    } else {
        content.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
        toggleText.textContent = 'Show';
        localStorage.setItem('yourTasksExpanded', 'false');
    }
}

// Restore state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const expanded = localStorage.getItem('yourTasksExpanded');
    if (expanded === 'true') {
        const content = document.getElementById('your-tasks-content');
        const chevron = document.getElementById('your-tasks-chevron');
        const toggleText = document.getElementById('your-tasks-toggle-text');
        if (content) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            toggleText.textContent = 'Hide';
        }
    }
});
</script>

{% if user.is_admin %}
<script>
    let pendingCheckInterval;
    let pendingTasksData = [];
    let isFirstCheck = true;

    async function checkPendingSync(showLoading = false) {
        const loadingEl = document.getElementById('pending-sync-loading');
        const alertEl = document.getElementById('pending-sync-alert');
        const countEl = document.getElementById('pending-sync-count');
        const detailsEl = document.getElementById('pending-sync-details');

        // Show loading indicator on first check or when explicitly requested
        if (isFirstCheck || showLoading) {
            loadingEl.style.display = 'flex';
            alertEl.style.display = 'none';
        }

        try {
            const response = await fetch('/api/pending-sync-check');
            const data = await response.json();

            pendingTasksData = data.pending_tasks || [];

            // Hide loading indicator
            loadingEl.style.display = 'none';
            isFirstCheck = false;

            if (data.total_pending > 0) {
                countEl.textContent = data.total_pending;

                // Build clickable task links
                const detailsHtml = pendingTasksData.map(t =>
                    `<a href="#" onclick="syncTask(${t.task_id}, '${t.task_name.replace(/'/g, "\\'")}'); return false;"
                        class="sync-task-link" data-task-id="${t.task_id}">
                        <span class="task-name">${t.task_name}</span>:
                        <span class="job-count">${t.pending_count} job(s)</span>
                    </a>`
                ).join(' <span class="text-gray-300">â€¢</span> ');
                detailsEl.innerHTML = detailsHtml;

                alertEl.style.display = 'flex';

                // Add subtle pulse animation
                alertEl.classList.add('animate-pulse-subtle');
                setTimeout(() => alertEl.classList.remove('animate-pulse-subtle'), 1000);
            } else {
                alertEl.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking pending sync:', error);
            // Hide loading on error too
            loadingEl.style.display = 'none';
            isFirstCheck = false;
        }
    }

    async function syncTask(taskId, taskName) {
        const link = document.querySelector(`a[data-task-id="${taskId}"]`);
        if (link) {
            link.classList.add('syncing');
            link.innerHTML = `<span class="task-name">${taskName}</span>: <span class="syncing-text">syncing...</span>`;
        }

        try {
            const formData = new FormData();
            formData.append('task_id', taskId);

            const response = await fetch('/sync-completed', {
                method: 'POST',
                body: formData
            });

            if (response.ok || response.redirected) {
                // Remove this task from the pending list
                pendingTasksData = pendingTasksData.filter(t => t.task_id !== taskId);

                // Re-check to update the display
                await checkPendingSync();

                // Show success feedback
                showToast(`Synced jobs from "${taskName}" to queue`);
            } else {
                throw new Error('Sync failed');
            }
        } catch (error) {
            console.error('Error syncing task:', error);
            showToast(`Failed to sync "${taskName}"`, 'error');
            // Restore the link
            if (link) {
                const task = pendingTasksData.find(t => t.task_id === taskId);
                if (task) {
                    link.classList.remove('syncing');
                    link.innerHTML = `<span class="task-name">${taskName}</span>: <span class="job-count">${task.pending_count} job(s)</span>`;
                }
            }
        }
    }

    async function syncAllPending() {
        const btn = document.getElementById('sync-all-btn');
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Syncing...
        `;

        let syncedCount = 0;
        const tasksToSync = [...pendingTasksData];

        for (const task of tasksToSync) {
            try {
                const formData = new FormData();
                formData.append('task_id', task.task_id);

                const response = await fetch('/sync-completed', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok || response.redirected) {
                    syncedCount++;
                }
            } catch (error) {
                console.error(`Error syncing task ${task.task_id}:`, error);
            }
        }

        // Refresh the pending check
        await checkPendingSync();

        btn.disabled = false;
        btn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Sync All
        `;

        if (syncedCount > 0) {
            showToast(`Synced ${syncedCount} task(s) to queue`);
        }
    }

    function showToast(message, type = 'success') {
        // Remove existing toast
        const existingToast = document.getElementById('sync-toast');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.id = 'sync-toast';
        toast.className = `sync-toast ${type === 'error' ? 'sync-toast-error' : 'sync-toast-success'}`;
        toast.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'error'
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                }
            </svg>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => toast.classList.add('show'), 10);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function refreshPendingCheck() {
        const btn = event.currentTarget;
        btn.disabled = true;
        btn.querySelector('svg').classList.add('animate-spin');

        checkPendingSync(true).finally(() => {
            btn.disabled = false;
            btn.querySelector('svg').classList.remove('animate-spin');
        });
    }

    // Initial check after page load
    document.addEventListener('DOMContentLoaded', () => {
        // Check immediately
        checkPendingSync();

        // Then check every 30 seconds
        pendingCheckInterval = setInterval(checkPendingSync, 30000);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (pendingCheckInterval) {
            clearInterval(pendingCheckInterval);
        }
    });
</script>

<style>
    @keyframes pulse-subtle {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    .animate-pulse-subtle {
        animation: pulse-subtle 0.5s ease-in-out 2;
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Loading dots animation */
    .sync-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        width: 40px;
        height: 40px;
    }
    .sync-loader-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3B82F6;
        animation: sync-loader-bounce 1.4s ease-in-out infinite both;
    }
    .sync-loader-dot:nth-child(1) {
        animation-delay: -0.32s;
    }
    .sync-loader-dot:nth-child(2) {
        animation-delay: -0.16s;
    }
    .sync-loader-dot:nth-child(3) {
        animation-delay: 0s;
    }
    @keyframes sync-loader-bounce {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Clickable task links in alert */
    .sync-task-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 6px;
        background: rgba(234, 88, 12, 0.1);
        color: #C2410C;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .sync-task-link:hover {
        background: rgba(234, 88, 12, 0.2);
        transform: translateY(-1px);
    }
    .sync-task-link .task-name {
        font-weight: 600;
    }
    .sync-task-link .job-count {
        font-weight: 400;
        opacity: 0.8;
    }
    .sync-task-link.syncing {
        opacity: 0.6;
        pointer-events: none;
    }
    .sync-task-link .syncing-text {
        font-style: italic;
    }

    /* Toast notifications */
    .sync-toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    .sync-toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    .sync-toast-success {
        background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
        color: #166534;
        border: 1px solid rgba(22, 163, 74, 0.2);
    }
    .sync-toast-error {
        background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
        color: #DC2626;
        border: 1px solid rgba(220, 38, 38, 0.2);
    }
</style>
{% endif %}
{% endblock %}
