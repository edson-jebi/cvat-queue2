{% extends "base.html" %}
{% block title %}Dashboard - CVAT Queue{% endblock %}

{% block content %}
<div class="mb-10">
    <h1 class="apple-title-2 text-gray-900">Dashboard</h1>
    <p class="apple-subheadline text-gray-500 mt-2">Select a task to view its jobs</p>
</div>

{% if user.is_admin %}
<!-- Loading indicator for pending sync check -->
<div id="pending-sync-loading" class="apple-alert apple-alert-info mb-8">
    <div class="apple-alert-icon">
        <div class="sync-loader">
            <div class="sync-loader-dot"></div>
            <div class="sync-loader-dot"></div>
            <div class="sync-loader-dot"></div>
        </div>
    </div>
    <div class="apple-alert-content">
        <p class="apple-body font-medium">Checking for completed jobs...</p>
        <p class="apple-footnote text-gray-500 mt-1">Scanning tasks for jobs ready to sync</p>
    </div>
</div>

<!-- Dynamic alert for pending sync jobs (admin only) -->
<div id="pending-sync-alert" class="apple-alert apple-alert-warning mb-8" style="display: none;">
    <div class="apple-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
    </div>
    <div class="apple-alert-content">
        <p class="apple-body">
            <span id="pending-sync-count" class="font-semibold">0</span> completed job(s) ready for queue sync
        </p>
        <p id="pending-sync-details" class="apple-footnote text-gray-500 mt-1"></p>
    </div>
    <div class="flex gap-2">
        <button onclick="syncAllPending()" id="sync-all-btn" class="apple-btn apple-btn-sm apple-btn-primary" title="Sync All">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Sync All
        </button>
        <button onclick="refreshPendingCheck()" class="apple-btn apple-btn-sm apple-btn-ghost" title="Refresh">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>
</div>
{% endif %}

{% if pending_count > 0 %}
<div class="apple-alert apple-alert-info mb-8">
    <div class="apple-alert-icon">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
    </div>
    <div class="apple-alert-content">
        <p class="apple-body">
            <span class="font-semibold">{{ pending_count }}</span> job(s) waiting for validation
        </p>
    </div>
    <a href="/queue" class="apple-btn apple-btn-sm apple-btn-secondary">
        View Queue
    </a>
</div>
{% endif %}

<!-- Queue Activity by Task with Project Sankey (shown first) -->
{% if top_tasks %}
<div class="apple-card">
    <div class="apple-card-header">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-3">
                <h2>Queue Activity by Task</h2>
                <span class="apple-badge apple-badge-info">Top {{ top_tasks|length }}</span>
            </div>
            <div class="flex items-center gap-2">
                <label for="task-limit" class="text-sm text-gray-500">Show:</label>
                <select id="task-limit" class="apple-select text-sm" style="width: auto; padding: 4px 24px 4px 10px;" onchange="filterTopTasks()">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>
    </div>

    <div class="sankey-container">
        <!-- Projects Column (Left) -->
        <div class="sankey-projects">
            <div class="sankey-column-header">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
                Projects
            </div>
            {% for project in projects_summary %}
            <div class="sankey-project-node"
                 data-project="{{ project.project_name }}"
                 data-task-ids="{{ project.task_ids|join(',') }}"
                 onmouseenter="highlightProject('{{ project.project_name }}')"
                 onmouseleave="clearHighlight()">
                <div class="sankey-node-content">
                    <span class="sankey-node-name truncate">{{ project.project_name }}</span>
                    <div class="sankey-node-stats">
                        <span class="sankey-stat">{{ project.task_ids|length }} tasks</span>
                        <span class="sankey-stat">{{ project.total_jobs }} jobs</span>
                    </div>
                </div>
                <div class="sankey-node-bar" style="--bar-width: {{ (project.total_jobs / (projects_summary|map(attribute='total_jobs')|max or 1) * 100)|int }}%"></div>
            </div>
            {% endfor %}
        </div>

        <!-- Connection Lines (SVG) -->
        <div class="sankey-connections" id="sankey-svg-container">
            <svg id="sankey-lines" width="100%" height="100%" preserveAspectRatio="none"></svg>
        </div>

        <!-- Tasks Table (Right) -->
        <div class="sankey-tasks">
            <div class="apple-table-container" style="border: none; border-radius: 0;">
                <table class="apple-table" id="top-tasks-table">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th class="text-center">Frames</th>
                            <th class="text-center">Jobs</th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                    Pend
                                </span>
                            </th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                                    Rev
                                </span>
                            </th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                    Val
                                </span>
                            </th>
                            <th class="text-center">
                                <span class="inline-flex items-center gap-1">
                                    <span class="w-2 h-2 rounded-full bg-red-400"></span>
                                    Rej
                                </span>
                            </th>
                            <th class="text-right">Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in top_tasks %}
                        <tr class="top-task-row"
                            data-index="{{ loop.index }}"
                            data-task-id="{{ task.task_id }}"
                            data-project="{{ task.project_name }}"
                            onmouseenter="highlightTask({{ task.task_id }}, '{{ task.project_name }}')"
                            onmouseleave="clearHighlight()">
                            <td>
                                <a href="/task/{{ task.task_id }}" class="font-medium text-blue-600 hover:text-blue-800 hover:underline">
                                    {{ task.task_name }}
                                </a>
                                <span class="text-xs text-gray-400 ml-1">#{{ task.task_id }}</span>
                            </td>
                            <td class="text-center">
                                {% if task.frames > 0 %}
                                <span class="text-gray-600 text-sm">{{ "{:,}".format(task.frames) }}</span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center font-semibold">{{ task.total_jobs }}</td>
                            <td class="text-center">
                                {% if task.pending > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
                                    {{ task.pending }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if task.in_review > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                    {{ task.in_review }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if task.validated > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                    {{ task.validated }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if task.rejected > 0 %}
                                <span class="inline-flex items-center justify-center min-w-[20px] px-1.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                    {{ task.rejected }}
                                </span>
                                {% else %}
                                <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right" style="min-width: 100px;">
                                {% set completed = task.validated + task.rejected %}
                                {% set progress = (completed / task.total_jobs * 100) if task.total_jobs > 0 else 0 %}
                                <div class="flex items-center justify-end gap-2">
                                    <div class="apple-progress" style="width: 50px; height: 5px;">
                                        <div class="apple-progress-bar {% if progress == 100 %}apple-progress-bar-green{% elif progress >= 50 %}apple-progress-bar-blue{% else %}apple-progress-bar-yellow{% endif %}" style="width: {{ progress }}%;"></div>
                                    </div>
                                    <span class="text-xs text-gray-500 w-8 text-right">{{ progress|round|int }}%</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="p-4 border-t border-gray-100 bg-gray-50/50">
        <div class="flex items-center justify-between text-sm text-gray-500">
            <span>
                Showing <span id="visible-count">{{ top_tasks|length }}</span> of {{ top_tasks|length }} tasks with queue activity
            </span>
            <span class="text-xs">
                Hover over projects or tasks to see connections
            </span>
        </div>
    </div>
</div>

<style>
.sankey-container {
    display: flex;
    min-height: 400px;
    overflow: hidden;
}

.sankey-projects {
    width: 220px;
    flex-shrink: 0;
    padding: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-right: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.sankey-column-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 0.5rem;
}

.sankey-project-node {
    position: relative;
    padding: 0.75rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
}

.sankey-project-node:hover,
.sankey-project-node.highlighted {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateX(4px);
}

.sankey-project-node.dimmed {
    opacity: 0.4;
}

.sankey-node-content {
    position: relative;
    z-index: 1;
}

.sankey-node-name {
    display: block;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.sankey-node-stats {
    display: flex;
    gap: 0.75rem;
}

.sankey-stat {
    font-size: 0.6875rem;
    color: #64748b;
}

.sankey-node-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    width: var(--bar-width, 0%);
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
    border-radius: 0 3px 0 0;
}

.sankey-connections {
    width: 60px;
    flex-shrink: 0;
    position: relative;
}

#sankey-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.sankey-line {
    fill: none;
    stroke: #cbd5e1;
    stroke-width: 2;
    opacity: 0.5;
    transition: all 0.2s ease;
}

.sankey-line.highlighted {
    stroke: #3b82f6;
    stroke-width: 3;
    opacity: 1;
}

.sankey-line.dimmed {
    opacity: 0.1;
}

.sankey-tasks {
    flex: 1;
    overflow-x: auto;
}

.sankey-tasks .apple-table-container {
    border-radius: 0;
}

.top-task-row {
    transition: all 0.2s ease;
}

.top-task-row.highlighted {
    background: rgba(59, 130, 246, 0.08) !important;
}

.top-task-row.dimmed {
    opacity: 0.4;
}

.top-task-row.highlighted td:first-child {
    position: relative;
}

.top-task-row.highlighted td:first-child::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: #3b82f6;
}
</style>

<script>
// Draw initial connection lines
function drawSankeyLines() {
    const svg = document.getElementById('sankey-lines');
    if (!svg) return;

    const container = document.getElementById('sankey-svg-container');
    const projects = document.querySelectorAll('.sankey-project-node');
    const tasks = document.querySelectorAll('.top-task-row');

    svg.innerHTML = '';

    const containerRect = container.getBoundingClientRect();

    projects.forEach(project => {
        const projectName = project.dataset.project;
        const taskIds = project.dataset.taskIds.split(',').map(id => id.trim());
        const projectRect = project.getBoundingClientRect();

        taskIds.forEach(taskId => {
            const taskRow = document.querySelector(`.top-task-row[data-task-id="${taskId}"]`);
            if (taskRow && taskRow.style.display !== 'none') {
                const taskRect = taskRow.getBoundingClientRect();

                const x1 = 0;
                const y1 = projectRect.top + projectRect.height / 2 - containerRect.top;
                const x2 = 60;
                const y2 = taskRect.top + taskRect.height / 2 - containerRect.top;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = 30;
                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                path.setAttribute('class', 'sankey-line');
                path.setAttribute('data-project', projectName);
                path.setAttribute('data-task-id', taskId);
                svg.appendChild(path);
            }
        });
    });
}

function highlightProject(projectName) {
    // Highlight project node
    document.querySelectorAll('.sankey-project-node').forEach(node => {
        if (node.dataset.project === projectName) {
            node.classList.add('highlighted');
            node.classList.remove('dimmed');
        } else {
            node.classList.add('dimmed');
            node.classList.remove('highlighted');
        }
    });

    // Highlight related tasks
    document.querySelectorAll('.top-task-row').forEach(row => {
        if (row.dataset.project === projectName && row.style.display !== 'none') {
            row.classList.add('highlighted');
            row.classList.remove('dimmed');
        } else {
            row.classList.add('dimmed');
            row.classList.remove('highlighted');
        }
    });

    // Highlight connection lines
    document.querySelectorAll('.sankey-line').forEach(line => {
        if (line.dataset.project === projectName) {
            line.classList.add('highlighted');
            line.classList.remove('dimmed');
        } else {
            line.classList.add('dimmed');
            line.classList.remove('highlighted');
        }
    });
}

function highlightTask(taskId, projectName) {
    // Highlight task row
    document.querySelectorAll('.top-task-row').forEach(row => {
        if (row.dataset.taskId == taskId) {
            row.classList.add('highlighted');
            row.classList.remove('dimmed');
        } else {
            row.classList.add('dimmed');
            row.classList.remove('highlighted');
        }
    });

    // Highlight parent project
    document.querySelectorAll('.sankey-project-node').forEach(node => {
        if (node.dataset.project === projectName) {
            node.classList.add('highlighted');
            node.classList.remove('dimmed');
        } else {
            node.classList.add('dimmed');
            node.classList.remove('highlighted');
        }
    });

    // Highlight connection line
    document.querySelectorAll('.sankey-line').forEach(line => {
        if (line.dataset.taskId == taskId) {
            line.classList.add('highlighted');
            line.classList.remove('dimmed');
        } else {
            line.classList.add('dimmed');
            line.classList.remove('highlighted');
        }
    });
}

function clearHighlight() {
    document.querySelectorAll('.sankey-project-node, .top-task-row, .sankey-line').forEach(el => {
        el.classList.remove('highlighted', 'dimmed');
    });
}

function filterTopTasks() {
    const limit = document.getElementById('task-limit').value;
    const rows = document.querySelectorAll('.top-task-row');
    let visibleCount = 0;

    rows.forEach((row, index) => {
        if (limit === 'all' || index < parseInt(limit)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    document.getElementById('visible-count').textContent = visibleCount;

    // Redraw Sankey lines after filtering
    setTimeout(drawSankeyLines, 50);
}

// Initialize Sankey lines on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(drawSankeyLines, 100);
});

// Redraw on window resize
window.addEventListener('resize', function() {
    clearTimeout(window.sankeyResizeTimeout);
    window.sankeyResizeTimeout = setTimeout(drawSankeyLines, 100);
});
</script>
{% endif %}

<!-- Collapsible Your Tasks Section -->
<div class="apple-card mt-8">
    <div class="apple-card-header cursor-pointer select-none" onclick="toggleYourTasks()" id="your-tasks-header">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-3">
                <h2>Your Tasks</h2>
                {% if tasks %}
                <span class="apple-badge apple-badge-secondary">{{ tasks|length }}</span>
                {% endif %}
            </div>
            <button type="button" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                <span id="your-tasks-toggle-text">Show</span>
                <svg id="your-tasks-chevron" class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="your-tasks-content" class="hidden">
        {% if tasks %}
        <div class="apple-table-container">
            <table class="apple-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Size</th>
                        <th>Assignee</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="font-mono text-gray-500">{{ task.id }}</td>
                        <td class="font-medium">{{ task.name }}</td>
                        <td>
                            <span class="apple-badge apple-state-{{ task.status.lower().replace(' ', '_') }}">
                                {{ task.status }}
                            </span>
                        </td>
                        <td style="min-width: 140px;">
                            <div class="apple-progress-container">
                                <div class="apple-progress" style="flex: 1;">
                                    <div class="apple-progress-bar {% if task.progress_percent == 100 %}apple-progress-bar-green{% elif task.progress_percent >= 50 %}apple-progress-bar-blue{% else %}apple-progress-bar-yellow{% endif %}" style="width: {{ task.progress_percent }}%;"></div>
                                </div>
                                <span class="apple-progress-text">{{ task.progress_percent }}%</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">{{ task.completed_jobs_count }}/{{ task.jobs_count }} jobs</div>
                        </td>
                        <td class="text-gray-500">{{ task.size }} frames</td>
                        <td class="text-gray-500">{{ task.assignee or '-' }}</td>
                        <td class="text-right">
                            <a href="/task/{{ task.id }}" class="apple-btn apple-btn-ghost apple-btn-sm">
                                View Jobs
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="apple-empty-state">
            <div class="apple-empty-icon">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h3 class="apple-empty-heading">No Tasks Found</h3>
            <p class="apple-empty-text">
                Tasks will appear here once you have access in CVAT.<br>
                Contact your administrator if you need access.
            </p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleYourTasks() {
    const content = document.getElementById('your-tasks-content');
    const chevron = document.getElementById('your-tasks-chevron');
    const toggleText = document.getElementById('your-tasks-toggle-text');

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
        toggleText.textContent = 'Hide';
        localStorage.setItem('yourTasksExpanded', 'true');
    } else {
        content.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
        toggleText.textContent = 'Show';
        localStorage.setItem('yourTasksExpanded', 'false');
    }
}

// Restore state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const expanded = localStorage.getItem('yourTasksExpanded');
    if (expanded === 'true') {
        const content = document.getElementById('your-tasks-content');
        const chevron = document.getElementById('your-tasks-chevron');
        const toggleText = document.getElementById('your-tasks-toggle-text');
        if (content) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            toggleText.textContent = 'Hide';
        }
    }
});
</script>

{% if user.is_admin %}
<script>
    let pendingCheckInterval;
    let pendingTasksData = [];
    let isFirstCheck = true;

    async function checkPendingSync(showLoading = false) {
        const loadingEl = document.getElementById('pending-sync-loading');
        const alertEl = document.getElementById('pending-sync-alert');
        const countEl = document.getElementById('pending-sync-count');
        const detailsEl = document.getElementById('pending-sync-details');

        // Show loading indicator on first check or when explicitly requested
        if (isFirstCheck || showLoading) {
            loadingEl.style.display = 'flex';
            alertEl.style.display = 'none';
        }

        try {
            const response = await fetch('/api/pending-sync-check');
            const data = await response.json();

            pendingTasksData = data.pending_tasks || [];

            // Hide loading indicator
            loadingEl.style.display = 'none';
            isFirstCheck = false;

            if (data.total_pending > 0) {
                countEl.textContent = data.total_pending;

                // Build clickable task links
                const detailsHtml = pendingTasksData.map(t =>
                    `<a href="#" onclick="syncTask(${t.task_id}, '${t.task_name.replace(/'/g, "\\'")}'); return false;"
                        class="sync-task-link" data-task-id="${t.task_id}">
                        <span class="task-name">${t.task_name}</span>:
                        <span class="job-count">${t.pending_count} job(s)</span>
                    </a>`
                ).join(' <span class="text-gray-300">â€¢</span> ');
                detailsEl.innerHTML = detailsHtml;

                alertEl.style.display = 'flex';

                // Add subtle pulse animation
                alertEl.classList.add('animate-pulse-subtle');
                setTimeout(() => alertEl.classList.remove('animate-pulse-subtle'), 1000);
            } else {
                alertEl.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking pending sync:', error);
            // Hide loading on error too
            loadingEl.style.display = 'none';
            isFirstCheck = false;
        }
    }

    async function syncTask(taskId, taskName) {
        const link = document.querySelector(`a[data-task-id="${taskId}"]`);
        if (link) {
            link.classList.add('syncing');
            link.innerHTML = `<span class="task-name">${taskName}</span>: <span class="syncing-text">syncing...</span>`;
        }

        try {
            const formData = new FormData();
            formData.append('task_id', taskId);

            const response = await fetch('/sync-completed', {
                method: 'POST',
                body: formData
            });

            if (response.ok || response.redirected) {
                // Remove this task from the pending list
                pendingTasksData = pendingTasksData.filter(t => t.task_id !== taskId);

                // Re-check to update the display
                await checkPendingSync();

                // Show success feedback
                showToast(`Synced jobs from "${taskName}" to queue`);
            } else {
                throw new Error('Sync failed');
            }
        } catch (error) {
            console.error('Error syncing task:', error);
            showToast(`Failed to sync "${taskName}"`, 'error');
            // Restore the link
            if (link) {
                const task = pendingTasksData.find(t => t.task_id === taskId);
                if (task) {
                    link.classList.remove('syncing');
                    link.innerHTML = `<span class="task-name">${taskName}</span>: <span class="job-count">${task.pending_count} job(s)</span>`;
                }
            }
        }
    }

    async function syncAllPending() {
        const btn = document.getElementById('sync-all-btn');
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Syncing...
        `;

        let syncedCount = 0;
        const tasksToSync = [...pendingTasksData];

        for (const task of tasksToSync) {
            try {
                const formData = new FormData();
                formData.append('task_id', task.task_id);

                const response = await fetch('/sync-completed', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok || response.redirected) {
                    syncedCount++;
                }
            } catch (error) {
                console.error(`Error syncing task ${task.task_id}:`, error);
            }
        }

        // Refresh the pending check
        await checkPendingSync();

        btn.disabled = false;
        btn.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
            </svg>
            Sync All
        `;

        if (syncedCount > 0) {
            showToast(`Synced ${syncedCount} task(s) to queue`);
        }
    }

    function showToast(message, type = 'success') {
        // Remove existing toast
        const existingToast = document.getElementById('sync-toast');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.id = 'sync-toast';
        toast.className = `sync-toast ${type === 'error' ? 'sync-toast-error' : 'sync-toast-success'}`;
        toast.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'error'
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                }
            </svg>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => toast.classList.add('show'), 10);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function refreshPendingCheck() {
        const btn = event.currentTarget;
        btn.disabled = true;
        btn.querySelector('svg').classList.add('animate-spin');

        checkPendingSync(true).finally(() => {
            btn.disabled = false;
            btn.querySelector('svg').classList.remove('animate-spin');
        });
    }

    // Initial check after page load
    document.addEventListener('DOMContentLoaded', () => {
        // Check immediately
        checkPendingSync();

        // Then check every 30 seconds
        pendingCheckInterval = setInterval(checkPendingSync, 30000);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (pendingCheckInterval) {
            clearInterval(pendingCheckInterval);
        }
    });
</script>

<style>
    @keyframes pulse-subtle {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    .animate-pulse-subtle {
        animation: pulse-subtle 0.5s ease-in-out 2;
    }
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Loading dots animation */
    .sync-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        width: 40px;
        height: 40px;
    }
    .sync-loader-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3B82F6;
        animation: sync-loader-bounce 1.4s ease-in-out infinite both;
    }
    .sync-loader-dot:nth-child(1) {
        animation-delay: -0.32s;
    }
    .sync-loader-dot:nth-child(2) {
        animation-delay: -0.16s;
    }
    .sync-loader-dot:nth-child(3) {
        animation-delay: 0s;
    }
    @keyframes sync-loader-bounce {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Clickable task links in alert */
    .sync-task-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 6px;
        background: rgba(234, 88, 12, 0.1);
        color: #C2410C;
        text-decoration: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .sync-task-link:hover {
        background: rgba(234, 88, 12, 0.2);
        transform: translateY(-1px);
    }
    .sync-task-link .task-name {
        font-weight: 600;
    }
    .sync-task-link .job-count {
        font-weight: 400;
        opacity: 0.8;
    }
    .sync-task-link.syncing {
        opacity: 0.6;
        pointer-events: none;
    }
    .sync-task-link .syncing-text {
        font-style: italic;
    }

    /* Toast notifications */
    .sync-toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    .sync-toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    .sync-toast-success {
        background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
        color: #166534;
        border: 1px solid rgba(22, 163, 74, 0.2);
    }
    .sync-toast-error {
        background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
        color: #DC2626;
        border: 1px solid rgba(220, 38, 38, 0.2);
    }
</style>
{% endif %}
{% endblock %}
